function varargout = TAgui_fitwindow(varargin)
% TAGUI_FITWINDOW Provide user with all necessary controls to perform
% basic fit functions on a given dataset.
%
% Normally, this window is called from within the TAgui window.
%
% See also TAGUI

% (c) 2011-12, Till Biskup
% 2012-02-04

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Construct the components
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Make GUI effectively a singleton
singleton = findobj('Tag','TAgui_fitwindow');
if (singleton)
    figure(singleton);
    varargout{1} = singleton;
    return;
end

%  Construct the components
hMainFigure = figure('Tag','TAgui_fitwindow',...
    'Visible','off',...
    'Name','TA GUI : Fit Window',...
    'Units','Pixels',...
    'Position',[30,50,800,680],...
    'Resize','off',...
    'NumberTitle','off', ...
    'KeyPressFcn',@keypress_Callback,...
    'Menu','none','Toolbar','none');

defaultBackground = get(hMainFigure,'Color');
mainPanelWidth = 260;
mainPanelHeight = 550;
panel_size = 240;
guiSize = get(hMainFigure,'Position');
guiSize = guiSize([3,4]);

hPlotAxes = axes(...         % the axes for plotting selected plot
    'Tag','axis',...
	'Parent', hMainFigure, ...
    'FontUnit','Pixel','Fontsize',14,...
    'Box','on',...
    'Layer','top',...
    'Units', 'Pixels', ...
    'Position',[70 250 400 400]);
uicontrol('Tag','slider',...
    'Style', 'slider',...
	'Parent', hMainFigure, ...
    'Min',1,'Max',100,'Value',50,...
    'Position', [485 250 15 400],...
    'BackgroundColor',[1 1 1],...
    'TooltipString','',...
    'Enable','off',...
    'Callback', {@position_slider_Callback}...
    );

% Create button group, toggle buttons for switching btw. panels
hButtonGroup = uibuttongroup('Tag','mainButtonGroup',...
    'BackgroundColor',defaultBackground,...
    'BorderType','none',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position', [guiSize(1)-mainPanelWidth-20 guiSize(2)-50 mainPanelWidth 30],...
    'Visible','on',...
    'SelectionChangeFcn',{@tbg_Callback});
tb1 = uicontrol('Tag','datasets_togglebutton',...
    'Style','Toggle',...
	'Parent', hButtonGroup, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Display',...
    'TooltipString','Select the dataset and review the display settings',...
    'pos',[0 0 (mainPanelWidth)/3 30],...
    'Enable','on'...
    );
tb2 = uicontrol('Tag','fit_togglebutton',...
    'Style','Toggle',...
	'Parent', hButtonGroup, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Fit',...
    'TooltipString','Set parameters for accumulation',...
    'pos',[mainPanelWidth/3 0 (mainPanelWidth)/3 30],...
    'Enable','on'...
    );
tb3 = uicontrol('Tag','settings_togglebutton',...
    'Style','Toggle',...
	'Parent', hButtonGroup, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Settings',...
    'TooltipString','Show results of accumulation',...
    'pos',[mainPanelWidth/3*2 0 (mainPanelWidth)/3 30],...
    'Enable','on'...
    );

% Create (switchable and overlaying) main panels
pp1 = uipanel('Tag','display_panel',...
    'parent',hMainFigure,...
    'Title','Display',...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[guiSize(1)-mainPanelWidth-20 70 mainPanelWidth mainPanelHeight]);

pp2 = uipanel('Tag','fit_panel',...
    'parent',hMainFigure,...
    'Title','Fit',...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'BackgroundColor',defaultBackground,...
    'Visible','off',...
    'Units','pixels',...
    'Position',[guiSize(1)-mainPanelWidth-20 70 mainPanelWidth mainPanelHeight]);

pp3 = uipanel('Tag','settings_panel',...
    'parent',hMainFigure,...
    'Title','Settings',...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'BackgroundColor',defaultBackground,...
    'Visible','off',...
    'Units','pixels',...
    'Position',[guiSize(1)-mainPanelWidth-20 70 mainPanelWidth mainPanelHeight]);

pp4 = uipanel('Tag','report_panel',...
    'parent',hMainFigure,...
    'Title','Report',...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[20 20 guiSize(1)-mainPanelWidth-50 170]);

% elements for pp1
pp1_p1 = uipanel('Tag','visible_panel',...
    'Parent',pp1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-120 mainPanelWidth-20 100],...
    'Title','Visible datasets'...
    );
uicontrol('Tag','visible_panel_listbox',...
    'Style','listbox',...
    'Parent',pp1_p1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 10 panel_size(1)-20 70],...
    'TooltipString','List of currently visible spectra',...
    'String','',...
    'Callback',{@visible_panel_listbox_Callback}...
    );

uicontrol('Tag','showonlyactive_checkbox',...
    'Style','checkbox',...
    'Parent',pp1,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'TooltipString','Check to display only the currently active dataset',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-165 130 35],...
    'String','<html>&nbsp;Show only<br />&nbsp;active dataset</html>',...
    'Value',0,...
    'Callback',{@checkbox_Callback,'showonlyactive'}...
    );
uicontrol('Tag','dataset_prev_pushbutton',...
    'Style','pushbutton',...
    'Parent',pp1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[mainPanelWidth-100 mainPanelHeight-165 45 35],...
    'String','<<',...
    'TooltipString','Add currently highlighted spectrum to list of accumulated spectra',...
    'Enable','on',...
    'Callback', {@pushbutton_Callback,'prev'}...
    );
uicontrol('Tag','dataset_next_pushbutton',...
    'Style','pushbutton',...
    'Parent',pp1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[mainPanelWidth-55 mainPanelHeight-165 45 35],...
    'String','>>',...
    'TooltipString','Remove currently highlighted spectrum from list of accumulated spectra',...
    'Enable','on',...
    'Callback', {@pushbutton_Callback,'next'}...
    );

pp1_p2 = uipanel('Tag','sliderposition_panel',...
    'Parent',pp1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-305 mainPanelWidth-20 135],...
    'Title','Slider position'...
    );
uicontrol('Tag','sliderposition_index_text',...
    'Style','text',...
    'Parent',pp1_p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 90 (mainPanelWidth-90)/2 25],...
    'String','index'...
    );
uicontrol('Tag','sliderposition_unit_text',...
    'Style','text',...
    'Parent',pp1_p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 90 (mainPanelWidth-90)/2 25],...
    'String','unit'...
    );
uicontrol('Tag','sliderposition_x_text',...
    'Style','text',...
    'Parent',pp1_p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 70 35 20],...
    'String','x'...
    );
uicontrol('Tag','sliderposition_x_index_edit',...
    'Style','edit',...
    'Parent',pp1_p2,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 70 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@position_edit_Callback,'xindex'}...
    );
uicontrol('Tag','sliderposition_x_unit_edit',...
    'Style','edit',...
    'Parent',pp1_p2,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 70 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@position_edit_Callback,'xunit'}...
    );
uicontrol('Tag','sliderposition_y_text',...
    'Style','text',...
    'Parent',pp1_p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 40 35 20],...
    'String','y'...
    );
uicontrol('Tag','sliderposition_y_index_edit',...
    'Style','edit',...
    'Parent',pp1_p2,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 40 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@position_edit_Callback,'yindex'}...
    );
uicontrol('Tag','sliderposition_y_unit_edit',...
    'Style','edit',...
    'Parent',pp1_p2,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 40 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@position_edit_Callback,'yunit'}...
    );
uicontrol('Tag','slider_panel_show_position_checkbox',...
    'Style','checkbox',...
    'Parent',pp1_p2,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'TooltipString','Check to display current position in main display',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[20 10 100 25],...
    'String','Show',...
    'Value',0,...
    'Callback',{@showposition_checkbox_Callback}...
    );
uicontrol('Tag','slider_panel_maximum_pushbutton',...
    'Style','pushbutton',...
    'Parent',pp1_p2,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 10 (mainPanelWidth-90)/2 25],...
    'String','Maximum',...
    'TooltipString','Set position to maximum in both dimensions',...
    'Callback',{@pushbutton_Callback,'showMaximum'}...
    );

pp1_p3 = uipanel('Tag','measure_panel',...
    'Parent',pp1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-450 mainPanelWidth-20 135],...
    'Title','Measure'...
    );
uicontrol('Tag','measure_index_text',...
    'Style','text',...
    'Parent',pp1_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 90 (mainPanelWidth-90)/2 25],...
    'String','index'...
    );
uicontrol('Tag','measure_unit_text',...
    'Style','text',...
    'Parent',pp1_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 90 (mainPanelWidth-90)/2 25],...
    'String','unit'...
    );
uicontrol('Tag','measure_x_text',...
    'Style','text',...
    'Parent',pp1_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 70 35 20],...
    'String','x'...
    );
uicontrol('Tag','measure_x_index_edit',...
    'Style','edit',...
    'Parent',pp1_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 70 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@position_edit_Callback,'xindex'}...
    );
uicontrol('Tag','measure_x_unit_edit',...
    'Style','edit',...
    'Parent',pp1_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 70 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@position_edit_Callback,'xunit'}...
    );
uicontrol('Tag','measure_y_text',...
    'Style','text',...
    'Parent',pp1_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 40 35 20],...
    'String','y'...
    );
uicontrol('Tag','measure_y_index_edit',...
    'Style','edit',...
    'Parent',pp1_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 40 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@position_edit_Callback,'yindex'}...
    );
uicontrol('Tag','measure_y_unit_edit',...
    'Style','edit',...
    'Parent',pp1_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 40 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@position_edit_Callback,'yunit'}...
    );
uicontrol('Tag','measure_pick_togglebutton',...
    'Style','togglebutton',...
    'Parent',pp1_p3,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 10 (mainPanelWidth-90)/2 25],...
    'String','Pick',...
    'TooltipString','Pick point to measure',...
    'Callback',{@togglebutton_Callback,'measurePick'}...
    );
uicontrol('Tag','measure_clear_pushbutton',...
    'Style','pushbutton',...
    'Parent',pp1_p3,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 10 (mainPanelWidth-90)/2 25],...
    'String','Clear',...
    'TooltipString','Clear current measurement',...
    'Callback',{@pushbutton_Callback,'measureClear'}...
    );

pp1_p4 = uipanel('Tag','displaytype_panel',...
    'Parent',pp1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-540 panel_size 80],...
    'Title','Display types'...
    );
uicontrol('Tag','displaytype_popupmenu',...
    'Style','popupmenu',...
    'Parent',pp1_p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 40 panel_size-20 20],...
    'String','2D plot|1D along x|1D along y',...
    'Callback', {@popupmenu_Callback,'displaytype'}...
    );
uicontrol('Tag','mfedisplaytype_popupmenu',...
    'Style','popupmenu',...
    'Parent',pp1_p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 10 panel_size-20 20],...
    'String',...
    'MFoff|MFon|DeltaMF|sum(MFoff,MFon)',...
    'Callback', {@popupmenu_Callback,'mfedisplaytype'}...
    );

% elements for pp2

pp2_p1 = uipanel('Tag','dimension_panel',...
    'Parent',pp2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-70 mainPanelWidth-20 50],...
    'Title','Fit dimension'...
    );
uicontrol('Tag','dimension_popupmenu',...
    'Style','popupmenu',...
    'Parent',pp2_p1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 10 mainPanelWidth-40 20],...
    'String','x  ---  B0 spectrum|y  ---  time trace',...
    'Callback', {@popupmenu_Callback,'dimension'}...
    );

pp2_p2 = uipanel('Tag','fitarea_panel',...
    'Parent',pp2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-245 mainPanelWidth-20 165],...
    'Title','Fit area'...
    );
uicontrol('Tag','fitarea_index_text',...
    'Style','text',...
    'Parent',pp2_p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 120 (mainPanelWidth-90)/2 25],...
    'String','index'...
    );
uicontrol('Tag','fitarea_unit_text',...
    'Style','text',...
    'Parent',pp2_p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 120 (mainPanelWidth-90)/2 25],...
    'String','unit'...
    );
uicontrol('Tag','average_start_text',...
    'Style','text',...
    'Parent',pp2_p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','right',...
    'Units','Pixels',...
    'Position',[10 100 45 20],...
    'String','Start '...
    );
uicontrol('Tag','average_start_index_edit',...
    'Style','edit',...
    'Parent',pp2_p2,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 100 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@area_edit_Callback,'startindex'}...
    );
uicontrol('Tag','average_start_unit_edit',...
    'Style','edit',...
    'Parent',pp2_p2,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 100 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@area_edit_Callback,'startunit'}...
    );
uicontrol('Tag','average_stop_text',...
    'Style','text',...
    'Parent',pp2_p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','right',...
    'Units','Pixels',...
    'Position',[10 70 45 20],...
    'String','Stop '...
    );
uicontrol('Tag','average_stop_index_edit',...
    'Style','edit',...
    'Parent',pp2_p2,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 70 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@area_edit_Callback,'stopindex'}...
    );
uicontrol('Tag','average_stop_unit_edit',...
    'Style','edit',...
    'Parent',pp2_p2,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 70 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@area_edit_Callback,'stopunit'}...
    );
uicontrol('Tag','average_deltap_text',...
    'Style','text',...
    'Parent',pp2_p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','right',...
    'Units','Pixels',...
    'Position',[10 40 45 20],...
    'String','Delta '...
    );
uicontrol('Tag','average_delta_index_edit',...
    'Style','edit',...
    'Parent',pp2_p2,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 40 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@area_edit_Callback,'deltaindex'}...
    );
uicontrol('Tag','average_delta_unit_edit',...
    'Style','edit',...
    'Parent',pp2_p2,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 40 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@area_edit_Callback,'deltaunit'}...
    );
uicontrol('Tag','fitarea_draw_togglebutton',...
    'Style','togglebutton',...
    'Parent',pp2_p2,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 10 (mainPanelWidth-90)/2 25],...
    'String','Draw',...
    'Callback',{@togglebutton_Callback,'fitareaDraw'}...
    );
uicontrol('Tag','fitarea_reset_pushbutton',...
    'Style','pushbutton',...
    'Parent',pp2_p2,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 10 (mainPanelWidth-90)/2 25],...
    'String','Clear',...
    'Callback',{@pushbutton_Callback,'fitareaClear'}...
    );

pp2_p3 = uipanel('Tag','fitfunction_panel',...
    'Parent',pp2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-370 mainPanelWidth-20 115],...
    'Title','Fit function'...
    );
uicontrol('Tag','fitfunction_text',...
    'Style','text',...
    'Parent',pp2_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 70 35 20],...
    'String','fun '...
    );
uicontrol('Tag','fitfunction_popupmenu',...
    'Style','popupmenu',...
    'Parent',pp2_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 72 mainPanelWidth-90 20],...
    'String','linear|quadratic|exponential|biexponential',...
    'Callback', {@popupmenu_Callback,'fitfunction'}...
    );
uicontrol('Tag','fitfunction_edit',...
    'Style','edit',...
    'Parent',pp2_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','left',...
    'Units','Pixels',...
    'Position',[10 40 (mainPanelWidth-40) 25],...
    'String','c(1)*x+c(2)',...
    'Enable','inactive',...
    'Callback',{@edit_Callback,'fitfunction'}...
    );
uicontrol('Tag','ncoefficients_text',...
    'Style','text',...
    'Parent',pp2_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 10 (mainPanelWidth-40)/4*2-10 20],...
    'String','# coefficients '...
    );
uicontrol('Tag','ncoefficients_edit',...
    'Style','edit',...
    'Parent',pp2_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','center',...
    'Units','Pixels',...
    'Position',[10+(mainPanelWidth-40)/4*2 10 (mainPanelWidth-40)/4 25],...
    'String','2',...
    'Enable','inactive',...
    'Callback',{@edit_Callback,'ncoefficients'}...
    );
uicontrol('Tag','fitfunction_test_pushbutton',...
    'Style','pushbutton',...
    'Parent',pp2_p3,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10+(mainPanelWidth-40)/4*3 10 (mainPanelWidth-40)/4 25],...
    'String','Test',...
    'Callback',{@pushbutton_Callback,'fitFunctionTest'}...
    );

pp2_p4 = uipanel('Tag','fit_displayoptions_panel',...
    'Parent',pp2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-440 mainPanelWidth-20 60],...
    'Title','Fit display options'...
    );
uicontrol('Tag','fit_display_area_checkbox',...
    'Style','checkbox',...
    'Parent',pp2_p4,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'TooltipString',sprintf('%s\n%s',...
    'Check to display mean value(s) of the average(s)',...
    'as horizontal line(s) in main display'),...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[20 10 100 25],...
    'String','Area',...
    'Value',1,...
    'Callback',{@checkbox_Callback,'area'}...
    );
uicontrol('Tag','fit_display_residuals_checkbox',...
    'Style','checkbox',...
    'Parent',pp2_p4,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'TooltipString','Check to display display std deviation as error bars',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[120 10 100 25],...
    'String','Residuals',...
    'Value',0,...
    'Callback',{@checkbox_Callback,'residuals'}...
    );

uicontrol('Tag','fitparameters_pushbutton',...
    'Style','pushbutton',...
	'Parent', pp2, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Parameters',...
    'TooltipString','Perform fit with parameters set above',...
    'pos',[10 mainPanelHeight-490 (mainPanelWidth-20)/5*2 40],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'FitParameters'}...
    );

uicontrol('Tag','fit_pushbutton',...
    'Style','pushbutton',...
	'Parent', pp2, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Fit',...
    'TooltipString','Perform fit with parameters set above',...
    'pos',[10+(mainPanelWidth-20)/3*2 mainPanelHeight-490 (mainPanelWidth-20)/3 40],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'Fit'}...
    );

% pp2_p4 = uipanel('Tag','referencelines_panel',...
%     'Parent',pp2,...
%     'BackgroundColor',defaultBackground,...
%     'FontUnit','Pixel','Fontsize',12,...
%     'Units','Pixels',...
%     'Position',[10 mainPanelHeight-540 mainPanelWidth-20 110],...
%     'Title','Reference lines'...
%     );
% uicontrol('Tag','referencelines_type_text',...
%     'Style','text',...
%     'Parent',pp2_p4,...
%     'BackgroundColor',defaultBackground,...
%     'FontUnit','Pixel','Fontsize',12,...
%     'Units','Pixels',...
%     'Position',[10 60 50 25],...
%     'String','type'...
%     );
% uicontrol('Tag','referencelines_index_text',...
%     'Style','text',...
%     'Parent',pp2_p4,...
%     'BackgroundColor',defaultBackground,...
%     'FontUnit','Pixel','Fontsize',12,...
%     'Units','Pixels',...
%     'Position',[70 60 (mainPanelWidth-100)/2 25],...
%     'String','index'...
%     );
% uicontrol('Tag','referencelines_unit_text',...
%     'Style','text',...
%     'Parent',pp2_p4,...
%     'BackgroundColor',defaultBackground,...
%     'FontUnit','Pixel','Fontsize',12,...
%     'Units','Pixels',...
%     'Position',[70+(mainPanelWidth-100)/2 60 (mainPanelWidth-100)/2 25],...
%     'String','unit'...
%     );
% uicontrol('Tag','referencelines_popupmenu',...
%     'Style','popupmenu',...
%     'Parent',pp2_p4,...
%     'BackgroundColor',defaultBackground,...
%     'FontUnit','Pixel','Fontsize',12,...
%     'Units','Pixels',...
%     'Position',[10 42 60 20],...
%     'TooltipString',sprintf('%s\n%s',...
%     'Type of the reference line',...
%     'h - horizontal; v - vertical'),...
%     'String','h|v',...
%     'Callback', {@popupmenu_Callback,'bgfitfunction'}...
%     );
% uicontrol('Tag','referencelines_index_edit',...
%     'Style','edit',...
%     'Parent',pp2_p4,...
%     'BackgroundColor',[1 1 1],...
%     'FontUnit','Pixel','Fontsize',12,...
%     'Units','Pixels',...
%     'Position',[70 40 (mainPanelWidth-100)/2 25],...
%     'String','0',...
%     'Callback',{@position_edit_Callback,'xindex'}...
%     );
% uicontrol('Tag','referencelines_unit_edit',...
%     'Style','edit',...
%     'Parent',pp2_p4,...
%     'BackgroundColor',[1 1 1],...
%     'FontUnit','Pixel','Fontsize',12,...
%     'Units','Pixels',...
%     'Position',[70+(mainPanelWidth-100)/2 40 (mainPanelWidth-100)/2 25],...
%     'String','0',...
%     'Callback',{@position_edit_Callback,'xunit'}...
%     );
% uicontrol('Tag','referencelines_horizontal_pushbutton',...
%     'Style','pushbutton',...
%     'Parent',pp2_p4,...
%     'BackgroundColor',defaultBackground,...
%     'Enable','on',...
%     'FontUnit','Pixel','Fontsize',12,...
%     'Units','Pixels',...
%     'Position',[10 10 (mainPanelWidth-40)/3 25],...
%     'String','Horiz.',...
%     'TooltipString','Draw horizontal reference lines',...
%     'Callback',{@pushbutton_Callback,'referenceLinesHorizontal'}...
%     );
% uicontrol('Tag','referencelines_horizontal_pushbutton',...
%     'Style','pushbutton',...
%     'Parent',pp2_p4,...
%     'BackgroundColor',defaultBackground,...
%     'Enable','on',...
%     'FontUnit','Pixel','Fontsize',12,...
%     'Units','Pixels',...
%     'Position',[10+(mainPanelWidth-40)/3 10 (mainPanelWidth-40)/3 25],...
%     'String','Vert.',...
%     'TooltipString','Draw vertical reference lines',...
%     'Callback',{@pushbutton_Callback,'referenceLinesVertical'}...
%     );
% uicontrol('Tag','referencelines_horizontal_pushbutton',...
%     'Style','pushbutton',...
%     'Parent',pp2_p4,...
%     'BackgroundColor',defaultBackground,...
%     'Enable','on',...
%     'FontUnit','Pixel','Fontsize',12,...
%     'Units','Pixels',...
%     'Position',[10+(mainPanelWidth-40)/3*2 10 (mainPanelWidth-40)/3 25],...
%     'String','Clear',...
%     'TooltipString','Remove all reference lines from display',...
%     'Callback',{@pushbutton_Callback,'referenceLinesClear'}...
%     );

% controls for pp3
% ...

pp3_p1 = uipanel('Tag','grid_panel',...
    'Parent',pp3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-80 mainPanelWidth-20 60],...
    'Title','Grid'...
    );
uicontrol('Tag','grid_x_togglebutton',...
    'Style','Toggle',...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','X',...
    'TooltipString','Show grid in x',...
    'pos',[10 10 (mainPanelWidth-40)/4 30],...
    'parent',pp3_p1,...
    'HandleVisibility','off',...
    'Value',0,...
    'Callback',{@togglebutton_Callback,'gridx'}...
    );
uicontrol('Tag','grid_y_togglebutton',...
    'Style','Toggle',...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Y',...
    'TooltipString','Show grid in y',...
    'pos',[10+(mainPanelWidth-40)/4 10 (mainPanelWidth-40)/4 30],...
    'parent',pp3_p1,...
    'HandleVisibility','off',...
    'Value',0,...
    'Callback',{@togglebutton_Callback,'gridy'}...
    );
uicontrol('Tag','grid_minor_togglebutton',...
    'Style','Toggle',...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','minor',...
    'TooltipString',sprintf('%s\n%s','Show minor grid',...
    '(Works only in combination with X or Y grid)'),...
    'pos',[10+(mainPanelWidth-40)/4*2 10 (mainPanelWidth-40)/4 30],...
    'parent',pp3_p1,...
    'HandleVisibility','off',...
    'Value',0,...
    'Callback',{@togglebutton_Callback,'gridminor'}...
    );
uicontrol('Tag','grid_zero_togglebutton',...
    'Style','Toggle',...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','zero',...
    'TooltipString','Show dashed line at zero',...
    'pos',[10+(mainPanelWidth-40)/4*3 10 (mainPanelWidth-40)/4 30],...
    'parent',pp3_p1,...
    'HandleVisibility','off',...
    'Value',1,...
    'Callback',{@togglebutton_Callback,'gridzero'}...
    );


pp3_p2 = uipanel('Tag','fitareasettings_panel',...
    'Parent',pp3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-180 mainPanelWidth-20 90],...
    'Title','Fit area'...
    );
uicontrol('Tag','fitareasettings_colour_text',...
    'Style','text',...
    'Parent',pp3_p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 40 (mainPanelWidth-40)/4-10 20],...
    'String','Colour '...
    );
uicontrol('Tag','fitareasettings_coloursample_text',...
    'Style','text',...
    'Parent',pp3_p2,...
    'BackgroundColor',[0.5 0.5 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10+(mainPanelWidth-40)/4 42 (mainPanelWidth-40)/4-10 25],...
    'String',''...
    );
uicontrol('Tag','fitareasettings_colour_pushbutton',...
    'Style','pushbutton',...
    'Parent',pp3_p2,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10+(mainPanelWidth-40)/4*2 40 (mainPanelWidth-40)/4*2 30],...
    'String','Palette...',...
    'Callback',{@pushbutton_Callback,'fitareaColourPalette'}...
    );
uicontrol('Tag','fitareasettings_alpha_text',...
    'Style','text',...
    'Parent',pp3_p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 10 (mainPanelWidth-40)/4-10 20],...
    'String','Alpha '...
    );
uicontrol('Tag','fitareasettings_alpha_edit',...
    'Style','edit',...
    'Parent',pp3_p2,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','center',...
    'Units','Pixels',...
    'Position',[10+(mainPanelWidth-40)/4 10 (mainPanelWidth-40)/4-10 25],...
    'String','0.4',...
    'Enable','on',...
    'Callback',{@edit_Callback,'fitareaAlpha'}...
    );
uicontrol('Tag','fitareasettings_alpha_slider',...
    'Style', 'slider',...
	'Parent', pp3_p2, ...
    'Min',0,'Max',1,'Value',0.4,...
    'Position', [10+(mainPanelWidth-40)/4*2 10 (mainPanelWidth-40)/4*2 20],...
    'TooltipString','',...
    'Enable','on',...
    'Callback',{@slider_Callback,'fitareaAlpha'}...
    );

pp3_p3 = uipanel('Tag','linesettings_panel',...
    'Parent',pp3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-375 mainPanelWidth-20 185],...
    'Title','Line settings'...
    );
uicontrol('Tag','linesettings_line_text',...
    'Style','text',...
    'Parent',pp3_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 138 60 20],...
    'String','Line'...
    );
uicontrol('Tag','linesettings_line_popupmenu',...
    'Style','popupmenu',...
    'Parent',pp3_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[80 140 mainPanelWidth-110 20],...
    'String','MFoff|MFon|DeltaMF|Residuals|Reference lines',...
    'Callback',{@popupmenu_Callback,'line'}...
    );
uicontrol('Tag','linesettings_colour_text',...
    'Style','text',...
    'Parent',pp3_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 103 60 20],...
    'String','Colour'...
    );
uicontrol('Tag','linesettings_coloursample_text',...
    'Style','text',...
    'Parent',pp3_p3,...
    'BackgroundColor',[0 0 0],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[80 102 40 25],...
    'String',''...
    );
uicontrol('Tag','linesettings_colour_pushbutton',...
    'Style','pushbutton',...
    'Parent',pp3_p3,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[130 100 100 30],...
    'String','Palette...',...
    'Callback',{@pushbutton_Callback,'lineColourPalette'}...
    );
uicontrol('Tag','linesettings_linewidth_text',...
    'Style','text',...
    'Parent',pp3_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 68 60 20],...
    'String','Width'...
    );
uicontrol('Tag','linesettings_linewidth_popupmenu',...
    'Style','popupmenu',...
    'Parent',pp3_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[80 70 mainPanelWidth-110 20],...
    'String','1 px|2 px|3 px|4 px|5 px',...
    'Callback',{@popupmenu_Callback,'linewidth'}...
    );
uicontrol('Tag','linesettings_linestyle_text',...
    'Style','text',...
    'Parent',pp3_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 38 60 20],...
    'String','Style'...
    );
uicontrol('Tag','linesettings_linestyle_popupmenu',...
    'Style','popupmenu',...
    'Parent',pp3_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[80 40 mainPanelWidth-110 20],...
    'String','solid|dashed|dotted|dash-dotted|none',...
    'Callback',{@popupmenu_Callback,'linestyle'}...
    );
uicontrol('Tag','linesettings_linemarker_text',...
    'Style','text',...
    'Parent',pp3_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 8 60 20],...
    'String','Marker'...
    );
uicontrol('Tag','linesettings_linemarker_popupmenu',...
    'Style','popupmenu',...
    'Parent',pp3_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[80 10 mainPanelWidth-110 20],...
    'String',['none|plus|circle|asterisk|point|cross|square|diamond|'...
    'triangle up|triangle down|triangle right|triangle left|'...
    'pentagram|hexagram'],...
    'Callback',{@popupmenu_Callback,'linemarker'}...
    );

uicontrol('Tag','settings_save_pushbutton',...
    'Style','pushbutton',...
	'Parent', pp3, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Save',...
    'TooltipString','Save current settings to configuration file',...
    'pos',[10 10 (mainPanelWidth-20)/2 40],...
    'Enable','off',...
    'Callback',{@pushbutton_Callback,'SettingsSave'}...
    );
uicontrol('Tag','settings_default_pushbutton',...
    'Style','pushbutton',...
	'Parent', pp3, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Defaults',...
    'TooltipString','Reset settings to default settings',...
    'pos',[10+(mainPanelWidth-20)/2 10 (mainPanelWidth-20)/2 40],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'SettingsDefault'}...
    );


reportPanelSize = get(pp4,'Position');
uicontrol('Tag','summary_panel_edit',...
    'Style','edit',...
    'Parent',pp4,...
    'BackgroundColor',[1 1 1],...
    'Units','Pixels',...
    'FontUnit','Pixel','Fontsize',12,...
    'FontName','FixedWidth',...
    'HorizontalAlignment','Left',...
    'Position',[10 40 reportPanelSize(3)-20 reportPanelSize(4)-60],...
    'Enable','inactive',...
    'Max',2,'Min',0,...
    'String','Nothing to report yet...');
uicontrol('Tag','summary_panel_reportclear_pushbutton',...
    'Style','pushbutton',...
	'Parent',pp4, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Clear',...
    'TooltipString','Clear report shown above',...
    'pos',[reportPanelSize(3)-150 10 70 25],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'reportClear'}...
    );
uicontrol('Tag','summary_panel_reportsave_pushbutton',...
    'Style','pushbutton',...
	'Parent',pp4, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Save',...
    'TooltipString','Save report shown above to text file',...
    'pos',[reportPanelSize(3)-80 10 70 25],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'reportSave'}...
    );

uicontrol('Tag','zoom_togglebutton',...
    'Style','togglebutton',...
	'Parent', hMainFigure, ...
    'BackgroundColor',defaultBackground,...
    'ForegroundColor',[0 0 0],...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'String','+',...
    'TooltipString','Zoom',...
    'pos',[panel_size*2+5 220 25 25],...
    'Enable','on',...
    'Callback',{@togglebutton_Callback,'Zoom'}...
    );

uicontrol('Tag','help_pushbutton',...
    'Style','pushbutton',...
	'Parent', hMainFigure, ...
    'BackgroundColor',defaultBackground,...
    'ForegroundColor',[0 0 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'String','?',...
    'TooltipString','Display help for how to operate the fit GUI',...
    'pos',[panel_size*2+5 190 25 25],...
    'Enable','on',...
    'Callback',@TAgui_fit_helpwindow...
    );

uicontrol('Tag','close_pushbutton',...
    'Style','pushbutton',...
	'Parent', hMainFigure, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Close',...
    'TooltipString','Close Fit GUI',...
    'pos',[guiSize(1)-((mainPanelWidth)/3)-10 20 (mainPanelWidth)/3-10 40],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'Close'}...
    );

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Initialization tasks
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Store handles in guidata
guidata(hMainFigure,guihandles);

% Create appdata structure
ad = guiDataStructure('guiappdatastructure');

% Apply configuration
guiConfigApply(mfilename);
ad.configuration = getappdata(hMainFigure,'configuration');

% ACC - struct
ad.fit = struct();
ad.fit = ad.configuration.fit;
ad.fit.values = [];

setappdata(hMainFigure,'data',ad.data);
setappdata(hMainFigure,'origdata',ad.origdata);
setappdata(hMainFigure,'configuration',ad.configuration);
setappdata(hMainFigure,'control',ad.control);
setappdata(hMainFigure,'fit',ad.fit);

% Make the GUI visible.
set(hMainFigure,'Visible','on');
msgStr = 'fit GUI window opened';
add2status(msgStr);

% Load data from Main GUI
mainGuiWindow = guiGetWindowHandle();
if (mainGuiWindow)
    admain = getappdata(mainGuiWindow);
    % Check for availability of necessary fields in appdata
    if (isfield(admain,'data') ~= 0)
        ad.data = admain.data;
        % Add fit struct to each dataset
        for l=1:length(ad.data)
            ad.data{l}.fit.area.start = 1;
            ad.data{l}.fit.area.stop = 1;
            ad.data{l}.fit.area.delta = 0;
            ad.data{l}.fit.label = '';
            ad.data{l}.fit.dimension = ad.configuration.fit.dimension;
        end
        setappdata(hMainFigure,'data',ad.data);
        ad.origdata = admain.data;
        setappdata(hMainFigure,'origdata',ad.origdata);
    end
    if (isfield(admain,'control') ~= 0)
        ad.control = admain.control;
        ad.control.axis.grid.zero = ad.configuration.axis.grid.zero;
        ad.control.axis.grid.x = ad.configuration.axis.grid.x;
        ad.control.axis.grid.y = ad.configuration.axis.grid.y;
        ad.control.axis.grid.minor = ad.configuration.axis.grid.minor;
        ad.control.axis.onlyActive = ad.configuration.axis.onlyActive;
        setappdata(hMainFigure,'control',ad.control);
    end
    
    updateSpectra();
    ad = getappdata(hMainFigure);
end

% Set fit GUI specific fields in control structure
ad.control.axis.position = false;
ad.control.axis.ignorefirstn = ad.configuration.fit.display.ignorefirstn;
setappdata(hMainFigure,'control',ad.control);

updateAxes();
updateFitPanel();
update_position_display();

if (nargout == 1)
    varargout{1} = hMainFigure;
end

% Create function-global cell arrays with line styles and markers
% The first column contains the "names", the second column the values
lineStyles = {...
    'solid','-'; ...
    'dashed','--'; ...
    'dotted',':'; ...
    'dash-dotted','-.'; ...
    'none','none' ...
    };
lineMarker = {...
    'none','none'; ...
    'plus','+'; ...
    'circle','o'; ...
    'asterisk','*'; ...
    'point','.'; ...
    'cross','x'; ...
    'square','s'; ...
    'diamond','d'; ...
    'triangle up','^'; ...
    'triangle down','v'; ...
    'triangle right','<'; ...
    'triangle left','>'; ...
    'pentagram','p'; ...
    'hexagram','h' ...
    };

% ------------------------------------------------------------------------
% Read config files for fit function (TAfit)
fitRoutinesConfigFileName = 'TAfit_fitroutines.ini';
fitFunctionsConfigFileName = 'TAfit_fitfunctions.ini';
path = fullfile(TAinfo('dir'),'analysis');
% Check for availability of configuration files
% If configuration files don't exist, create them from distributed
% configuration files.
if ~exist(fullfile(path,fitRoutinesConfigFileName),'file')
    fprintf('%s\n%s',...
        'Configuration for fit routines doesn''t exist.',...
        'Trying to create...');
    conf = TAiniFileRead(...
        fullfile(path,[fitRoutinesConfigFileName '.dist']),...
        'typeConversion',true);
    header = 'Configuration file for TAfit function of TA toolbox';
    TAiniFileWrite(fullfile(path,fitRoutinesConfigFileName),...
        conf,'header',header,'overwrite',true);
    fprintf(' done\n');
end
if ~exist(fullfile(path,fitFunctionsConfigFileName),'file')
    fprintf('%s\n%s',...
        'Configuration for fit functions doesn''t exist.',...
        'Trying to create...');
    conf = TAiniFileRead(...
        fullfile(path,[fitFunctionsConfigFileName '.dist']),...
        'typeConversion',true);
    header = 'Configuration file for TAfit function of TA toolbox';
    TAiniFileWrite(fullfile(path,fitFunctionsConfigFileName),...
        conf,'header',header,'overwrite',true);
    fprintf(' done\n');
end
[fitRoutines,warnings] = TAiniFileRead(...
    fullfile(path,fitRoutinesConfigFileName),...
    'typeConversion',true);
if ~isempty(warnings)
    message = warnings;
    return;
end
[fitFunctions,warnings] = TAiniFileRead(...
    fullfile(path,'TAfit_fitfunctions.ini'),...
    'typeConversion',true);
if ~isempty(warnings)
    message = warnings;
    return;
end
% Set popupmenu contents for fit functions accordingly
set(gh.fitfunction_popupmenu,'String',...
    structfun(@(x) cellstr(x.name),fitFunctions))
%fitFunctionNames = structfun(@(x) cellstr(x.name),fitFunctions);

% Test whether fit routines exist in current Matlab installation
% If not, remove part of struct from fitRoutines
fitRoutineNames = fieldnames(fitRoutines);
for k=1:length(fitRoutineNames)
    if ~exist(fitRoutineNames{k},'file')
        fitRoutines.(fitRoutineNames) = [];
    end
end

ad.fit.fitRoutines = fitRoutines;
ad.fit.fitFunctions = fitFunctions;
setappdata(hMainFigure,'fit',ad.fit);
% END OF Read config files for fit function (TAfit)
% ------------------------------------------------------------------------

% Add keypress function to every element that can have one...
handles = findall(...
    allchild(hMainFigure),'style','pushbutton',...
    '-or','style','togglebutton',...
    '-or','style','edit',...
    '-or','style','listbox',...
    '-or','style','popupmenu');
for m=1:length(handles)
    set(handles(m),'KeyPressFcn',@keypress_Callback);
end


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Callbacks
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function tbg_Callback(source,~)
    try 
        switchPanel(get(get(source,'SelectedObject'),'String'));
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function position_slider_Callback(source,~)
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata from fit GUI
        ad = getappdata(mainWindow);
        
        % Depending on display type settings
        switch ad.control.axis.displayType
            case '1D along x'
                ad.data{ad.control.spectra.active}.display.position.y = ...
                    int16(get(source,'value'));
            case '1D along y'
                ad.data{ad.control.spectra.active}.display.position.x = ...
                    int16(get(source,'value'));
            otherwise
                msg = sprintf('Display type %s currently unsupported',...
                    ad.control.axis.displayType);
                add2status(msg);
        end
        
        % Set appdata from fit GUI
        setappdata(mainWindow,'data',ad.data);
        
        updateAxes();
        update_position_display();
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function position_edit_Callback(source,~,position)
    try
        if isempty(position)
            return;
        end
                
        % If value is empty or NaN after conversion to numeric, restore
        % previous entry and return
        value = get(source,'String');
        if isempty(value) || ...
                ((isnan(str2double(value))) && ~strcmpi(value,'end'))
            % Update slider panel
            updateSliderPanel();
            return;
        end
        
        % Get appdata of fit GUI
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        active = ad.control.spectra.active;
        
        % Be as robust as possible: if there is no axes, default is indices
        [y,x] = size(ad.data{active}.data);
        x = linspace(1,x,x);
        y = linspace(1,y,y);
        if (isfield(ad.data{active},'axes') ...
                && isfield(ad.data{active}.axes,'x') ...
                && isfield(ad.data{active}.axes.x,'values') ...
                && not (isempty(ad.data{active}.axes.x.values)))
            x = ad.data{active}.axes.x.values;
        end
        if (isfield(ad.data{active},'axes') ...
                && isfield(ad.data{active}.axes,'y') ...
                && isfield(ad.data{active}.axes.y,'values') ...
                && not (isempty(ad.data{active}.axes.y.values)))
            y = ad.data{active}.axes.y.values;
        end
        
        switch position
            case 'xindex'
                if strcmpi(value,'end')
                    value = length(x);
                else
                    value = round(str2double(value));
                    if (value > length(x)) value = length(x); end
                    if (value < 1) value = 1; end
                end
                ad.data{active}.display.position.x = value;
            case 'xunit'
                if strcmpi(value,'end')
                    value = x(end);
                else
                    value = str2double(value);
                    if (value < x(1)) value = x(1); end
                    if (value > x(end)) value = x(end); end
                end
                ad.data{active}.display.position.x = ...
                    interp1(...
                    x,[1:length(x)],...
                    value,...
                    'nearest'...
                    );
            case 'yindex'
                if strcmpi(value,'end')
                    value = length(y);
                else
                    value = round(str2double(value));
                    if (value > length(y)) value = length(y); end
                    if (value < 1) value = 1; end
                end
                ad.data{active}.display.position.y = value;
            case 'yunit'
                if strcmpi(value,'end')
                    value = y(end);
                else
                    value = str2double(value);
                    if (value < y(1)) value = y(1); end
                    if (value > y(end)) value = y(end); end
                end
                ad.data{active}.display.position.y = ...
                    interp1(...
                    y,[1:length(y)],...
                    value,...
                    'nearest'...
                    );
            otherwise
                return;
        end
        
        % Update appdata of main window
        setappdata(mainWindow,'data',ad.data);
        
        % Update slider values display
        updateSliderPanel()

        %Update main axis
        updateAxes();
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function area_edit_Callback(source,~,position)
    try
        if isempty(position)
            return;
        end
        
        % If value is empty or NaN after conversion to numeric, restore
        % previous entry and return
        value = get(source,'String');
        if isempty(value) || ...
                ((isnan(str2double(value))) && ~strcmpi(value,'end'))
            % Update slider panel
            updateFitPanel();
            return;
        end
        
        % Get appdata of MFE GUI
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        % Get handles of main window
        gh = guihandles(mainWindow);
        
        % Make code lines shorter and code easier to read
        active = ad.control.spectra.active;
        
        if ~active
            return;
        end
        
        % Be as robust as possible: if there is no axes, default is indices
        [y,x] = size(ad.data{active}.data);
        x = linspace(1,x,x);
        y = linspace(1,y,y);
        if (isfield(ad.data{active},'axes') ...
                && isfield(ad.data{active}.axes,'x') ...
                && isfield(ad.data{active}.axes.x,'values') ...
                && not (isempty(ad.data{active}.axes.x.values)))
            x = ad.data{active}.axes.x.values;
        end
        if (isfield(ad.data{active},'axes') ...
                && isfield(ad.data{active}.axes,'y') ...
                && isfield(ad.data{active}.axes.y,'values') ...
                && not (isempty(ad.data{active}.axes.y.values)))
            y = ad.data{active}.axes.y.values;
        end

        if strcmpi(ad.fit.dimension,'x')
            dim = x;
        else
            dim = y;
        end
        
        switch position
            case 'startindex'
                if strcmpi(value,'end')
                    value = length(dim);
                else
                    value = round(str2double(value));
                    if (value > length(dim)) value = length(dim); end
                    if (value < 1) value = 1; end
                end
                ad.data{active}.fit.area.start = value;
                % Set stop value not overlapping
                if ad.data{active}.fit.area.start > ad.data{active}.fit.area.stop
                    % Check whether start + delta > length(dim)
                    if (ad.data{active}.fit.area.start + ad.data{active}.fit.area.delta > length(dim))
                        ad.data{active}.fit.area.stop = length(dim);
                        ad.data{active}.fit.area.delta = ...
                            ad.data{active}.fit.area.stop-ad.data{active}.fit.area.start;
                    else
                        ad.data{active}.fit.area.stop = ...
                            ad.data{active}.fit.area.start+ad.data{active}.fit.area.delta;
                    end
                end
                % Set delta value
                ad.data{active}.fit.area.delta = ...
                    ad.data{active}.fit.area.stop-ad.data{active}.fit.area.start;
            case 'startunit'
                if strcmpi(value,'end')
                    value = dim(end);
                else
                    value = str2double(value);
                    if (value < dim(1)) value = dim(1); end
                    if (value > dim(end)) value = dim(end); end
                end
                ad.data{active}.fit.area.start = ...
                    interp1(...
                    dim,1:length(dim),...
                    value,...
                    'nearest'...
                    );
                % Set stop value not overlapping
                if ad.data{active}.fit.area.start > ad.data{active}.fit.area.stop
                    % Check whether start + delta > length(dim)
                    if (ad.data{active}.fit.area.start + ad.data{active}.fit.area.delta > length(dim))
                        ad.data{active}.fit.area.stop = length(dim);
                        ad.data{active}.fit.area.delta = ...
                            ad.data{active}.fit.area.stop-ad.data{active}.fit.area.start;
                    else
                        ad.data{active}.fit.area.stop = ...
                            ad.data{active}.fit.area.start+ad.data{active}.fit.area.delta;
                    end
                end
                % Set delta value
                ad.data{active}.fit.area.delta = ...
                    ad.data{active}.fit.area.stop-ad.data{active}.fit.area.start;
            case 'stopindex'
                if strcmpi(value,'end')
                    value = length(dim);
                else
                    value = round(str2double(value));
                    if (value > length(dim)) value = length(dim); end
                    if (value < 1) value = 1; end
                end
                ad.data{active}.fit.area.stop = value;
                % Set start value not overlapping
                if ad.data{active}.fit.area.start > ad.data{active}.fit.area.stop
                    % Check whether stop - delta < length(dim)
                    if (ad.data{active}.fit.area.stop - ad.data{active}.fit.area.delta < 1)
                        ad.data{active}.fit.area.start = 1;
                        ad.data{active}.fit.area.delta = ...
                            ad.data{active}.fit.area.stop-ad.data{active}.fit.area.start;
                    else
                        ad.data{active}.fit.area.start = ...
                            ad.data{active}.fit.area.stop-ad.data{active}.fit.area.delta;
                    end
                end
                % Set delta value
                ad.data{active}.fit.area.delta = ...
                    ad.data{active}.fit.area.stop-ad.data{active}.fit.area.start;
            case 'stopunit'
                if strcmpi(value,'end')
                    value = dim(end);
                else
                    value = str2double(value);
                    if (value < dim(1)) value = dim(1); end
                    if (value > dim(end)) value = dim(end); end
                end
                ad.data{active}.fit.area.stop = ...
                    interp1(...
                    dim,1:length(dim),...
                    value,...
                    'nearest'...
                    );
                % Set start value not overlapping
                if ad.data{active}.fit.area.start > ad.data{active}.fit.area.stop
                    % Check whether stop - delta < length(dim)
                    if (ad.data{active}.fit.area.stop - ad.data{active}.fit.area.delta < 1)
                        ad.data{active}.fit.area.start = 1;
                        ad.data{active}.fit.area.delta = ...
                            ad.data{active}.fit.area.stop-ad.data{active}.fit.area.start;
                    else
                        ad.data{active}.fit.area.start = ...
                            ad.data{active}.fit.area.stop-ad.data{active}.fit.area.delta;
                    end
                end
                % Set delta value
                ad.data{active}.fit.area.delta = ...
                    ad.data{active}.fit.area.stop-ad.data{active}.fit.area.start;
            otherwise
                disp('TAgui_MFEwindow() : area_edit_Callback() : Unknown action');
                disp(action);
                return;
        end
        
        % Update appdata of main window
        setappdata(mainWindow,'data',ad.data);

        % Update fit panel
        updateFitPanel();
        
        %Update main axis
        updateAxes();
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function showposition_checkbox_Callback(source,~)
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata from fit GUI
        ad = getappdata(mainWindow);
        
        ad.control.axis.position = get(source,'Value');
        
        % Set appdata from fit GUI
        setappdata(mainWindow,'control',ad.control);
        
        % Update display
        updateAxes();
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function visible_panel_listbox_Callback(source,~)
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata from fit GUI
        ad = getappdata(mainWindow);
        
        ad.control.spectra.active = ad.control.spectra.visible(...
            get(source,'Value')...
            );
        
        % Set appdata from fit GUI
        setappdata(mainWindow,'control',ad.control);
        
        updateAxes();
        update_position_display();
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function edit_Callback(source,~,field)
    try
        if isempty(field)
            return;
        end
        
        % Get appdata of main window
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        value = get(source,'String');
        
        switch field
            case 'npts_clipping'
                value = str2double(value);
                xdim = size(ad.data{ad.control.spectra.active}.data,2);
                if isnan(value) || (value > xdim) || (value < 0)
                    set(source,'string',...
                        num2str(ad.control.axis.ignorefirstn));
                else
                    ad.control.axis.ignorefirstn = value;
                    setappdata(mainWindow,'control',ad.control)
                end
                updateAxes();
                return;
            case 'bgfit_ignorepoints'
                value = str2double(value);
                xdim = size(ad.data{ad.control.spectra.active}.data,2);
                if isnan(value) || (value > xdim) || (value < 0)
                    set(source,'string',...
                        num2str(ad.control.axis.ignorefirstn));
                else
                    ad.fft.bgfit.ignorefirstn = value;
                    setappdata(mainWindow,'fft',ad.fft)
                end
                updateAxes();
            otherwise
                return;
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function popupmenu_Callback(source,~,action)
    try
        if isempty(action)
            return;
        end
        
        % Get appdata of main window
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        % Get handles of main window
        gh = guihandles(mainWindow);
        
        values = cellstr(get(source,'String'));
        value = values{get(source,'Value')};

        % Get line type currently selected (MFoff/MFon/DeltaMF)
        MFElines = cellstr(get(gh.linesettings_line_popupmenu,'String'));
        MFEline = MFElines{get(gh.linesettings_line_popupmenu,'Value')};
        
        switch action
            case 'displaytype'
                displayTypes = cellstr(get(source,'String'));
                ad.control.axis.displayType = ...
                    displayTypes{get(source,'Value')};
                
                % Set appdata of main window
                setappdata(hMainFigure,'control',ad.control);
                
                % If no datasets are loaded, return
                % NOTE: As we return only here, the display type gets set
                % for later 
                if isempty(ad.data)
                    return;
                end
                
                switch ad.control.axis.displayType
                    case '2D plot'
                        set(gh.slider,'Enable','Off');
                        updateAxes();
                    case '1D along x'
                        set(gh.slider,'Enable','On');
                        updateAxes();
                    case '1D along y'
                        set(gh.slider,'Enable','On');
                        updateAxes();
                    otherwise
                        % unknown
                        return;
                end
            case 'mfedisplaytype'
                MFEdisplayTypes = cellstr(get(source,'String'));
                ad.control.axis.MFEdisplay = ...
                    MFEdisplayTypes{get(source,'Value')};
                % Set appdata of main window
                setappdata(hMainFigure,'control',ad.control);
                updateAxes();
            case 'dimension'
                ad.fit.dimension = value(1);
                setappdata(mainWindow,'fit',ad.fit);
                % Reset average values (safest way to prevent trouble)
                pushbutton_Callback('','','fitAreaClear');
                updateAxes();
            case 'fitfunction'
                fitFunNames = cellstr(get(gh.fitfunction_popupmenu,'String'));
                ad.fit.fitFunction = ...
                    fitFunNames{get(gh.fitfunction_popupmenu,'Value')};
                setappdata(mainWindow,'fit',ad.fit);
                updateFitPanel();
            case 'line'
                % Update settings panel
                updateSettingsPanel();
            case 'linewidth'
                % convert source string into number
                value = str2double(value(1:end-3));
                switch MFEline
                    case 'MFoff'
                        ad.fit.MFoff.line.width = value;
                    case 'MFon'
                        ad.fit.MFon.line.width = value;
                    case 'DeltaMF'
                        ad.fit.DeltaMF.line.width = value;
                    case 'Residuals'
                        ad.fit.residuals.line.width = value;
                    case 'Reference lines'
                        ad.fit.reference.line.width = value;
                    otherwise
                        disp(['TAgui : guiMFEPanel() : '...
                            'popupmenu_Callback(): Unknown MFElineType '...
                            '"' MFEline '"']);
                end
                setappdata(mainWindow,'fit',ad.fit);
                updateAxes();
            case 'linestyle'
                value = lineStyles{...
                    strcmpi(value,lineStyles(:,1)),2};
                switch MFEline
                    case 'MFoff'
                        ad.fit.MFoff.line.style = value;
                    case 'MFon'
                        ad.fit.MFon.line.style = value;
                    case 'DeltaMF'
                        ad.fit.DeltaMF.line.style = value;
                    case 'Residuals'
                        ad.fit.residuals.line.style = value;
                    case 'Reference lines'
                        ad.fit.reference.line.style = value;
                    otherwise
                        disp(['TAgui : guiMFEPanel() : '...
                            'popupmenu_Callback(): Unknown MFElineType '...
                            '"' MFEline '"']);
                end
                setappdata(mainWindow,'fit',ad.fit);
                updateAxes();
            case 'linemarker'
                value = lineMarker{...
                    strcmpi(value,lineMarker(:,1)),2};
                switch MFEline
                    case 'MFoff'
                        ad.fit.MFoff.line.marker = value;
                    case 'MFon'
                        ad.fit.MFon.line.marker = value;
                    case 'DeltaMF'
                        ad.fit.DeltaMF.line.marker = value;
                    case 'Residuals'
                        ad.fit.residuals.line.marker = value;
                    case 'Reference lines'
                        ad.fit.reference.line.marker = value;
                    otherwise
                        disp(['TAgui : guiMFEPanel() : '...
                            'popupmenu_Callback(): Unknown MFElineType '...
                            '"' MFEline '"']);
                end
                setappdata(mainWindow,'fit',ad.fit);
                updateAxes();
            otherwise
                disp('Unknown popupmenu')
                disp(action);
        end

    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end  
end

function togglebutton_Callback(source,~,action)
    try
        if isempty(action)
            return;
        end
        
        % Get appdata of main window
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        % Get handles of main window
        gh = guihandles(mainWindow);

        % Get state of toggle button
        value = get(source,'Value');
        
        % Toggle button
        if value % If toggle switched ON
            switch lower(action)
                case 'measurepick'
                    % Switch off zoom
                    zoom(mainWindow,'off');
                    % Set pointer callback functions
                    set(mainWindow,...
                        'WindowButtonMotionFcn',@trackPointer);
                    set(mainWindow,...
                        'WindowButtonDownFcn',@switchMeasurePointer);
                    return;
                case 'zoom'
                    % Reset pointer callback functions
                    set(mainWindow,'WindowButtonMotionFcn','');
                    set(mainWindow,'WindowButtonDownFcn','');
                    % Reset other zoom toggle button
                    zoom(mainWindow,'on');
                    return;
                case 'gridx'
                    ad.control.axis.grid.x = 'on';
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                case 'gridy'
                    ad.control.axis.grid.y = 'on';
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                case 'gridminor'
                    ad.control.axis.grid.minor = 'on';
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                case 'gridzero'
                    ad.control.axis.grid.zero = value;
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                otherwise
                    disp('TAgui_fitwindow: togglebutton_Callback(): Unknown action');
                    disp(action);
                    return;
            end
        else % If toggle button switched OFF
            switch lower(action)
                case 'measurepick'
                    % Reset pointer callback functions
                    set(mainWindow,'WindowButtonMotionFcn','');
                    set(mainWindow,'WindowButtonDownFcn','');
                    return;
                case 'zoom'
                    zoom(mainWindow,'off');
                    return;
                case 'gridx'
                    ad.control.axis.grid.x = 'off';
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                case 'gridy'
                    ad.control.axis.grid.y = 'off';
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                case 'gridminor'
                    ad.control.axis.grid.minor = 'off';
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                case 'gridzero'
                    ad.control.axis.grid.zero = value;
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                otherwise
                    disp('TAgui_fitwindow: togglebutton_Callback(): Unknown action');
                    disp(action);
                    return;
            end
        end
        
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function checkbox_Callback(source,~,action)
    try
        if isempty(action)
            return;
        end
        
        % Get appdata of MFE GUI
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        switch action
            case 'area'
                ad.fit.display.area = get(source,'Value');                
            case 'residuals'
                ad.fit.display.residuals = get(source,'Value');                
            case 'showonlyactive'
                ad.control.axis.onlyActive = get(source,'Value');
            otherwise
                disp([mfilename ' : pushbutton_Callback() : '...
                    'Unknown action "' action '"']);
                return;
        end
        setappdata(mainWindow,'fit',ad.fit);
        setappdata(mainWindow,'control',ad.control);
        updateFitPanel();
        updateAxes();
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function pushbutton_Callback(~,~,action)
    try
        if isempty(action)
            return;
        end
        
        % Get appdata of main window
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        % Get handles of main window
        gh = guihandles(mainWindow);

        active = ad.control.spectra.active;

        switch lower(action)
            case 'next'
                if isempty(ad.control.spectra.visible)
                    return;
                end
                selected = get(gh.visible_panel_listbox,'Value');
                if selected == length(ad.control.spectra.visible)
                    selected = 1;
                else
                    selected = selected + 1;
                end
                set(gh.visible_panel_listbox,'Value',selected);
                ad.control.spectra.active = selected;
                setappdata(mainWindow,'control',ad.control);
                updateAxes();
                updateSliderPanel();
            case 'prev'
                if isempty(ad.control.spectra.visible)
                    return;
                end
                selected = get(gh.visible_panel_listbox,'Value');
                if selected == 1
                    selected = length(ad.control.spectra.visible);
                else
                    selected = selected - 1;
                end
                set(gh.visible_panel_listbox,'Value',selected);
                ad.control.spectra.active = selected;
                setappdata(mainWindow,'control',ad.control);
                updateAxes();
                updateSliderPanel();
            case 'fitareaclear'
                ad.data{active}.fit.area.start = 1;
                ad.data{active}.fit.area.stop = 1;
                ad.data{active}.fit.area.delta = 0;
                setappdata(mainWindow,'data',ad.data);
                updateFitPanel();
                updateAxes();
                return;
            case 'fitparameters'
                TAgui_fit_parameterwindow();
            case 'fit'
                % Collect fit parameters
                fitParams = collectFitParameters;
                % Perform fit
                [ad.fit.values,fval,message] = ...
                    TAfit(ad.data{active},fitParams);
                % Set report
                set(gh.summary_panel_edit,'String',message);
                setappdata(mainWindow,'fit',ad.fit);
                updateAxes();
                return;
            case 'showmaximum'
                % If no datasets are loaded, return
                if isempty(ad.data)
                    return;
                end
                [~,ximax] = max(max(ad.data{active}.data));
                [~,yimax] = max(ad.data{active}.data(:,ximax));
                ad.data{active}.display.position.x = ximax;
                ad.data{active}.display.position.y = yimax;
                % Set appdata
                setappdata(mainWindow,'data',ad.data);
                
                updateAxes();
                update_position_display();
                return;
            case 'zoomreset'
                zoom(mainWindow,'off');
                set(gh.zoom_x_togglebutton,'Value',0);
                set(gh.zoom_xy_togglebutton,'Value',0);
                updateAxes();
                return;
            case'measureclear'
                set(gh.measure_pick_togglebutton,'Value',0);
                set(gh.measure_x_index_edit,'String','0');
                set(gh.measure_x_unit_edit,'String','0');
                set(gh.measure_y_index_edit,'String','0');
                set(gh.measure_y_unit_edit,'String','0');
                return;
            case 'fitareacolourpalette'
                ad.fit.area.patch.color = uisetcolor(...
                    ad.fit.area.patch.color,'Set fit area colour');
                setappdata(mainWindow,'fit',ad.fit);
                updateSettingsPanel();
                updateAxes();
                return;
            case 'linecolourpalette'
                % Get line type currently selected (MFoff/MFon/DeltaMF)
                MFElines = ...
                    cellstr(get(gh.linesettings_line_popupmenu,'String'));
                MFEline = ...
                    MFElines{get(gh.linesettings_line_popupmenu,'Value')};
                switch MFEline
                    case 'MFoff'
                        ad.fit.MFoff.line.color = uisetcolor(...
                            ad.fit.MFoff.line.color,...
                            'Set MFoff line colour');
                    case 'MFon'
                        ad.fit.MFon.line.color = ...
                            uisetcolor(...
                            ad.fit.MFon.line.color,...
                            'Set MFon line colour');
                    case 'DeltaMF'
                        ad.fit.DeltaMF.line.color = ...
                            uisetcolor(...
                            ad.fit.DeltaMF.line.color,...
                            'Set DeltaMF line colour');
                    case 'Residuals'
                        ad.fit.residuals.line.color = ...
                            uisetcolor(...
                            ad.fit.residuals.line.color,...
                            'Set Residuals line colour');
                    case 'Reference lines'
                        ad.fit.reference.line.color = ...
                            uisetcolor(...
                            ad.fit.residuals.line.color,...
                            'Set Reference lines line colour');
                    otherwise
                        disp(['TAgui_MFEwindow : pushbutton_Callback():'...
                            ' Unknown MFElineType "' MFEline '"']);
                end
        
                % Update appdata of main window
                setappdata(mainWindow,'fit',ad.fit);
                updateSettingsPanel();
                updateAxes();
                return;
            case 'settingsdefault'
                updateSettingsPanel('defaults');
                updateAxes();
                return;
            case 'reportclear'
                set(gh.summary_panel_edit,'String','');
                ad.fit.values = [];
                setappdata(mainWindow,'fit',ad.fit);
                updateAxes();
            case 'close'
                msgStr = 'Fit GUI window closed.';
                add2status(msgStr);

                % Look for fit GUI subwindow and if there are some, close
                % them as well
                hSubWindows = findobj('-regexp','Tag','TAgui_fit_*');
                for k=1:length(hSubWindows)
                    if ishandle(hSubWindows(k))
                        delete(hSubWindows(k));
                    end
                end
                delete(guiGetWindowHandle(mfilename));
            otherwise
                disp('TAgui_fitwindow: pushbutton_Callback(): Unknown action');
                disp(action);
                return;
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function slider_Callback(source,~,action)
    try
        if isempty(action)
            return;
        end
        
        % Get appdata of main window
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        % Get handles of main window
        gh = guihandles(mainWindow);

        % Get state of toggle button
        value = get(source,'Value');
        
        switch lower(action)
            case 'fitareaalpha'
                set(gh.fitareasettings_alpha_edit,'String',num2str(value));
            otherwise
                disp('TAgui_fitwindow: slider_Callback(): Unknown action');
                disp(action);
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end
    
function displaytype_popupmenu_Callback(source,~)
    try
        % Get appdata of main window
        ad = getappdata(hMainFigure);

        % Get handles of main window
        gh = guihandles(hMainFigure);
        
        displayTypes = cellstr(get(source,'String'));
        ad.control.axis.displayType = displayTypes{get(source,'Value')};
        
        % Set appdata of main window
        setappdata(hMainFigure,'control',ad.control);

        % If no datasets are loaded, return
        % NOTE: As we return only here, the display type gets set for later
        if isempty(ad.data)
            return;
        end

        switch ad.control.axis.displayType
            case '2D plot'
                set(gh.slider,'Enable','Off');
                updateAxes()
            case '1D along x'
                set(gh.slider,'Enable','On');
                updateAxes()
            case '1D along y'
                set(gh.slider,'Enable','On');
                updateAxes()
            otherwise
                % unknown
                return;
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function keypress_Callback(src,evt)
    try
        if isempty(evt.Character) && isempty(evt.Key)
            % In case "Character" is the empty string, i.e. only modifier key
            % was pressed...
            return;
        end
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata from fit GUI
        ad = getappdata(mainWindow);

        if ~isempty(evt.Modifier)
            if (strcmpi(evt.Modifier{1},'command')) || ...
                    (strcmpi(evt.Modifier{1},'control'))
                switch evt.Key
                    case 'w'
                        pushbutton_Callback(src,evt,'Close')
                        return;
                    case '1'
                        switchPanel('Display');
                        return;
                    case '2'
                        switchPanel('Fit');
                        return;
                    case '3'
                        switchPanel('Settings');
                        return;
                    case 'x'
                        ad.control.axis.displayType = '1D along x';
                        setappdata(mainWindow,'control',ad.control);
                        updateAxes();
                        return;
                    case 'y'
                        ad.control.axis.displayType = '1D along y';
                        setappdata(mainWindow,'control',ad.control);
                        updateAxes();
                        return;
                    case 'z'
                        ad.control.axis.displayType = '2D plot';
                        setappdata(mainWindow,'control',ad.control);
                        updateAxes();
                        return;
                end
            end
        end
        switch evt.Key
            case 'f1'
                TAgui_fit_helpwindow();
                return;
            otherwise
%                 disp(evt);
%                 fprintf('       Caller: %i\n\n',src);
                return;
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Utility functions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function switchPanel(panelName)
    try
        panels = [pp1 pp2 pp3];
        buttons = [tb1 tb2 tb3];
        switch panelName
            case 'Display'
                set(panels,'Visible','off');
                set(buttons,'Value',0);
                set(pp1,'Visible','on');
                set(tb1,'Value',1);
            case 'Fit'
                set(panels,'Visible','off');
                set(buttons,'Value',0);
                set(pp2,'Visible','on');
                set(tb2,'Value',1);
                updateFitPanel();
            case 'Settings'
                set(panels,'Visible','off');
                set(buttons,'Value',0);
                set(pp3,'Visible','on');
                set(tb3,'Value',1);
                updateSettingsPanel();
            otherwise
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

function updateSliderPanel()
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata of BLC GUI
        ad = getappdata(mainWindow);
        
        % Get handles of BLC GUI
        gh = guihandles(mainWindow);
        
        if ~isfield(ad,'data') || isempty(ad.data)
            set(findall(...
                allchild(gh.sliderposition_panel),...
                'Style','Edit'),'String','1');
            return;
        end

        % Get dimensions and axes of current dataset
        [y,x] = size(ad.data{ad.control.spectra.active}.data);
        x = linspace(1,x,x);
        y = linspace(1,y,y);
        if (isfield(ad.data{ad.control.spectra.active},'axes') ...
                && isfield(ad.data{ad.control.spectra.active}.axes,'x') ...
                && isfield(ad.data{ad.control.spectra.active}.axes.x,'values') ...
                && not (isempty(ad.data{ad.control.spectra.active}.axes.x.values)))
            x = ad.data{ad.control.spectra.active}.axes.x.values;
        end
        if (isfield(ad.data{ad.control.spectra.active},'axes') ...
                && isfield(ad.data{ad.control.spectra.active}.axes,'y') ...
                && isfield(ad.data{ad.control.spectra.active}.axes.y,'values') ...
                && not (isempty(ad.data{ad.control.spectra.active}.axes.y.values)))
            y = ad.data{ad.control.spectra.active}.axes.y.values;
        end
        % In case that we loaded 1D data...
        if isscalar(x)
            x = [x x+1];
        end
        if isscalar(y)
            y = [y y+1];
        end
        
        % update position panel
        set(...
            gh.sliderposition_x_index_edit,...
            'string',...
            ad.data{ad.control.spectra.active}.display.position.x...
            );
        set(...
            gh.sliderposition_x_unit_edit,...
            'string',...
            x(ad.data{ad.control.spectra.active}.display.position.x)...
            );
        set(...
            gh.sliderposition_y_index_edit,...
            'string',...
            ad.data{ad.control.spectra.active}.display.position.y...
            );
        set(...
            gh.sliderposition_y_unit_edit,...
            'string',...
            y(ad.data{ad.control.spectra.active}.display.position.y)...
            );
    catch exception
        try
            msgstr = ['an exception occurred. '...
                'the bug reporter should have been opened'];
            add2status(msgstr);
        catch exception2
            exception = addcause(exception2, exception);
            disp(msgstr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % if even displaying the bug report window fails...
            exception = addcause(exception3, exception);
            throw(exception);
        end
    end
end

function updateSpectra()
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata from fit GUI
        ad = getappdata(mainWindow);
        
        if isempty(ad.data) || isempty(ad.control.spectra.visible)
            return;
        end
        
        % Get handle for visible spectra listbox
        gh = guidata(mainWindow);
        visLbox = gh.visible_panel_listbox;
        
        % Get indices of invisible spectra
        vis = ad.control.spectra.visible;
        
        % Get names for display in listbox
        labels = cell(0);
        for k=1:length(vis)
            labels{k} = ad.data{vis(k)}.label;
        end
        
        % Update status display
        set(visLbox,'String',labels);
        if (get(visLbox,'Value')>length(vis))
            set(visLbox,'Value',length(vis));
        end
        if ((get(visLbox,'Value')==0) && ~isempty(vis))
            set(visLbox,'Value',1);
        end
        
        % Highlight currently active
        if ad.control.spectra.active
            set(visLbox,'Value',find(vis==ad.control.spectra.active));
        end
        
        % Change enable status of pushbuttons and other elements
        set(gh.slider_panel_maximum_pushbutton,'Enable','on');

    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
    
end

function updateSettingsPanel(varargin)
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata from AVG GUI
        ad = getappdata(mainWindow);

        % Get handles from main window
        gh = guidata(mainWindow);
               
        if nargin && strcmpi('defaults',varargin{1})
            % Reset display settings
            ad.control.axis.grid.x = ad.configuration.axis.grid.x;
            ad.control.axis.grid.y = ad.configuration.axis.grid.y;
            ad.control.axis.grid.minor = ad.configuration.axis.grid.minor;
            ad.control.axis.grid.zero = ad.configuration.axis.grid.zero;
            % Reset avg settings
            ad.fit = ad.configuration.fit;
            setappdata(mainWindow,'fit',ad.fit);
            setappdata(mainWindow,'control',ad.control);
        end
        
        if strcmpi('on',ad.control.axis.grid.x)
            set(gh.grid_x_togglebutton,'Value',1);
        else
            set(gh.grid_x_togglebutton,'Value',0);
        end
        if strcmpi('on',ad.control.axis.grid.y)
            set(gh.grid_y_togglebutton,'Value',1);
        else
            set(gh.grid_y_togglebutton,'Value',0);
        end
        if strcmpi('on',ad.control.axis.grid.minor)
            set(gh.grid_minor_togglebutton,'Value',1);
        else
            set(gh.grid_minor_togglebutton,'Value',0);
        end
        set(gh.grid_zero_togglebutton,'Value',ad.control.axis.grid.zero);
        
        set(gh.fitareasettings_coloursample_text,'Background',...
            ad.fit.area.patch.color);
        set(gh.fitareasettings_alpha_edit,'String',...
            num2str(ad.fit.area.patch.alpha));
        set(gh.fitareasettings_alpha_slider,'Value',...
            ad.fit.area.patch.alpha);
        
        % Get line type currently selected (MFoff/MFon/DeltaMF)
        MFElines = cellstr(get(gh.linesettings_line_popupmenu,'String'));
        MFEline = MFElines{get(gh.linesettings_line_popupmenu,'Value')};
        
        % Get values of line style popupmenu
        lineStyleValues = ...
            cellstr(get(gh.linesettings_linestyle_popupmenu,'String'));
        
        % Get values of line marker popupmenu
        lineMarkerValues = ...
            cellstr(get(gh.linesettings_linemarker_popupmenu,'String'));

        switch MFEline
            case 'MFoff'
                % Set colour sample
                set(gh.linesettings_coloursample_text,'BackgroundColor',...
                    ad.fit.MFoff.line.color);
                % Set line width
                set(gh.linesettings_linewidth_popupmenu,'Value',...
                    ad.fit.MFoff.line.width);
                % Set line style
                set(gh.linesettings_linestyle_popupmenu,'Value',...
                    find(strcmpi(...
                    lineStyles{strcmpi(ad.fit.MFoff.line.style,...
                    lineStyles(:,2)),1},lineStyleValues)));
                % Set line marker
                set(gh.linesettings_linemarker_popupmenu,'Value',...
                    find(strcmpi(...
                    lineMarker{strcmpi(ad.fit.MFoff.line.marker,...
                    lineMarker(:,2)),1},lineMarkerValues)));
            case 'MFon'
                % Set colour sample
                set(gh.linesettings_coloursample_text,'BackgroundColor',...
                    ad.fit.MFon.line.color);
                % Set line width
                set(gh.linesettings_linewidth_popupmenu,'Value',...
                    ad.fit.MFon.line.width);
                % Set line style
                set(gh.linesettings_linestyle_popupmenu,'Value',...
                    find(strcmpi(...
                    lineStyles{strcmpi(ad.fit.MFon.line.style,...
                    lineStyles(:,2)),1},lineStyleValues)));
                % Set line marker
                set(gh.linesettings_linemarker_popupmenu,'Value',...
                    find(strcmpi(...
                    lineMarker{strcmpi(ad.fit.MFon.line.marker,...
                    lineMarker(:,2)),1},lineMarkerValues)));
            case 'DeltaMF'
                % Set colour sample
                set(gh.linesettings_coloursample_text,'BackgroundColor',...
                    ad.fit.DeltaMF.line.color);
                % Set line width
                set(gh.linesettings_linewidth_popupmenu,'Value',...
                    ad.fit.DeltaMF.line.width);
                % Set line style
                set(gh.linesettings_linestyle_popupmenu,'Value',...
                    find(strcmpi(...
                    lineStyles{strcmpi(ad.fit.DeltaMF.line.style,...
                    lineStyles(:,2)),1},lineStyleValues)));
                % Set line marker
                set(gh.linesettings_linemarker_popupmenu,'Value',...
                    find(strcmpi(...
                    lineMarker{strcmpi(ad.fit.DeltaMF.line.marker,...
                    lineMarker(:,2)),1},lineMarkerValues)));
            case 'Residuals'
                % Set colour sample
                set(gh.linesettings_coloursample_text,'BackgroundColor',...
                    ad.fit.residuals.line.color)
                % Set line width
                set(gh.linesettings_linewidth_popupmenu,'Value',...
                    ad.fit.residuals.line.width);
                % Set line style
                set(gh.linesettings_linestyle_popupmenu,'Value',...
                    find(strcmpi(lineStyles{strcmpi(...
                    ad.fit.residuals.line.style,...
                    lineStyles(:,2)),1},lineStyleValues)));
                % Set line marker
                set(gh.linesettings_linemarker_popupmenu,'Value',...
                    find(strcmpi(lineMarker{...
                    strcmpi(ad.fit.residuals.line.marker,...
                    lineMarker(:,2)),1},lineMarkerValues)));
            case 'Reference lines'
                % Set colour sample
                set(gh.linesettings_coloursample_text,'BackgroundColor',...
                    ad.fit.reference.line.color)
                % Set line width
                set(gh.linesettings_linewidth_popupmenu,'Value',...
                    ad.fit.reference.line.width);
                % Set line style
                set(gh.linesettings_linestyle_popupmenu,'Value',...
                    find(strcmpi(lineStyles{strcmpi(...
                    ad.fit.reference.line.style,...
                    lineStyles(:,2)),1},lineStyleValues)));
                % Set line marker
                set(gh.linesettings_linemarker_popupmenu,'Value',...
                    find(strcmpi(lineMarker{...
                    strcmpi(ad.fit.reference.line.marker,...
                    lineMarker(:,2)),1},lineMarkerValues)));
            otherwise
                disp(['TAgui_MFEwindow : updateSettingsPanel() : ',...
                    'Unknown MFElineType "' MFEline '"']);
        end

    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

function update_position_display()
    mainWindow = guiGetWindowHandle(mfilename);
    % Get appdata from fit GUI
    ad = getappdata(mainWindow);

    if isempty(ad.data) || isempty(ad.control.spectra.visible)
        return;
    end
    
    % Get handle for visible spectra listbox
    gh = guidata(mainWindow);

    try
        % Set position in time edit boxes
        set(gh.sliderposition_y_index_edit,...
            'String',...
            num2str(ad.data{ad.control.spectra.active}.display.position.y));
        % Set unit
        [y,~] = size(ad.data{ad.control.spectra.active}.data);
        y = linspace(1,y,y);
        if (isfield(ad.data{ad.control.spectra.active},'axes') ...
                && isfield(ad.data{ad.control.spectra.active}.axes,'y') ...
                && isfield(ad.data{ad.control.spectra.active}.axes.y,'values') ...
                && not (isempty(ad.data{ad.control.spectra.active}.axes.y.values)))
            y = ad.data{ad.control.spectra.active}.axes.y.values;
        end
        set(gh.sliderposition_y_unit_edit,...
            'String',...
            num2str(y(ad.data{ad.control.spectra.active}.display.position.y)));
        
        % Set position in time edit boxes
        set(gh.sliderposition_x_index_edit,...
            'String',...
            num2str(ad.data{ad.control.spectra.active}.display.position.x));
        % Set unit
        [~,x] = size(ad.data{ad.control.spectra.active}.data);
        x = linspace(1,x,x);
        if (isfield(ad.data{ad.control.spectra.active},'axes') ...
                && isfield(ad.data{ad.control.spectra.active}.axes,'x') ...
                && isfield(ad.data{ad.control.spectra.active}.axes.x,'values') ...
                && not (isempty(ad.data{ad.control.spectra.active}.axes.x.values)))
            x = ad.data{ad.control.spectra.active}.axes.x.values;
        end
        set(gh.sliderposition_x_unit_edit,...
            'String',...
            num2str(x(ad.data{ad.control.spectra.active}.display.position.x)));
        
        % Set slider
        switch ad.control.axis.displayType
            case '1D along x'
                set(gh.slider,'Value',...
                    ad.data{ad.control.spectra.active}.display.position.y);
            case '1D along y'
                set(gh.slider,'Value',...
                    ad.data{ad.control.spectra.active}.display.position.x);
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

function updateFitPanel()
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata of fit GUI
        ad = getappdata(mainWindow);
        
        % Get handles of fit GUI
        gh = guihandles(mainWindow);
        
        % Set fit display checkboxes
        set(gh.fit_display_area_checkbox,'Value',...
            ad.fit.display.area);
        set(gh.fit_display_residuals_checkbox,'Value',...
            ad.fit.display.residuals);
        
        % Set fit function panel
        fitFunctionNames = structfun(@(x) cellstr(x.name),fitFunctions);
        fitFunAbbrevs = fieldnames(fitFunctions);
        fitFunAbbrev = fitFunAbbrevs{...
            strcmpi(fitFunctionNames,ad.fit.fitFunction)};
        set(gh.fitfunction_edit,'String',...
            fitFunctions.(fitFunAbbrev).function);
        set(gh.ncoefficients_edit,'String',...
            fitFunctions.(fitFunAbbrev).ncoeff);

        if ~isfield(ad,'data') || isempty(ad.data)
            set(findall(...
                allchild(gh.sliderposition_panel),...
                'Style','Edit'),'String','1');
            return;
        end

        % Make codelines shorter and easier to read
        active = ad.control.spectra.active;
        
        % Get dimensions and axes of current dataset
        [y,x] = size(ad.data{active}.data);
        x = linspace(1,x,x);
        y = linspace(1,y,y);
        if (isfield(ad.data{active},'axes') ...
                && isfield(ad.data{active}.axes,'x') ...
                && isfield(ad.data{active}.axes.x,'values') ...
                && not (isempty(ad.data{active}.axes.x.values)))
            x = ad.data{active}.axes.x.values;
        end
        if (isfield(ad.data{active},'axes') ...
                && isfield(ad.data{active}.axes,'y') ...
                && isfield(ad.data{active}.axes.y,'values') ...
                && not (isempty(ad.data{active}.axes.y.values)))
            y = ad.data{active}.axes.y.values;
        end
        % In case that we loaded 1D data...
        if isscalar(x)
            x = [x x+1];
        end
        if isscalar(y)
            y = [y y+1];
        end
        
        % update position panel
        set(...
            gh.average_start_index_edit,...
            'string',...
            ad.data{active}.fit.area.start...
            );
        set(...
            gh.average_stop_index_edit,...
            'string',...
            ad.data{active}.fit.area.stop...
            );
        set(...
            gh.average_delta_index_edit,...
            'string',...
            ad.data{active}.fit.area.delta...
            );

        if strcmpi(ad.fit.dimension,'x')
            set(gh.average_start_unit_edit,...
                'string',num2str(x(ad.data{active}.fit.area.start))...
                );
            set(gh.average_stop_unit_edit,...
                'string',num2str(x(ad.data{active}.fit.area.stop))...
                );
            set(gh.average_delta_unit_edit,...
                'string',num2str(abs(x(2)-x(1))*ad.data{active}.fit.area.delta)...
                );
        else
            set(gh.average_start_unit_edit,...
                'string',num2str(y(ad.data{active}.fit.area.start))...
                );
            set(gh.average_stop_unit_edit,...
                'string',num2str(y(ad.data{active}.fit.area.stop))...
                );
            set(gh.average_delta_unit_edit,...
                'string',num2str(abs(y(2)-y(1))*ad.data{active}.fit.area.delta)...
                );
        end
    catch exception
        try
            msgstr = ['an exception occurred. '...
                'the bug reporter should have been opened'];
            add2status(msgstr);
        catch exception2
            exception = addcause(exception2, exception);
            disp(msgstr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % if even displaying the bug report window fails...
            exception = addcause(exception3, exception);
            throw(exception);
        end
    end
end

function updateAxes()
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata from fit GUI
        ad = getappdata(mainWindow);
        
        % Get handles from main window
        gh = guidata(mainWindow);
        
        % Set displayType popupmenu
        displayTypes = cellstr(...
            get(gh.displaytype_popupmenu,'String'));
        [~,index] = max(strcmp(ad.control.axis.displayType,displayTypes));
        set(gh.displaytype_popupmenu,'Value',index);

        % Set display only active checkbox
        set(gh.showonlyactive_checkbox,'Value',...
            ad.control.axis.onlyActive);

        if isempty(ad.data) || isempty(ad.control.spectra.visible)
            return;
        end
        
        active = ad.control.spectra.active;
        
        data = ad.data{active}.data;
        if isfield(ad.data{active},'dataMFon')
            dataMFon = ad.data{active}.dataMFon;
        else
            dataMFon = ad.data{active}.data;
        end

        % Apply thresholds
        if ad.data{active}.display.threshold.min.enable
            data(data<ad.data{active}.display.threshold.min.value) = ...
                ad.data{active}.display.threshold.min.value;
        end
        if ad.data{active}.display.threshold.max.enable
            data(data>ad.data{active}.display.threshold.max.value) = ...
                ad.data{active}.display.threshold.max.value;
        end
        
        xvalues = ad.data{active}.axes.x.values;
        xmeasure = ad.data{active}.axes.x.measure;
        xunit = ad.data{active}.axes.x.unit;
        yvalues = ad.data{active}.axes.y.values;
        ymeasure = ad.data{active}.axes.y.measure;
        yunit = ad.data{active}.axes.y.unit;
        zmeasure = ad.data{active}.axes.z.measure;
        zunit = ad.data{active}.axes.z.unit;

        [y,x] = size(data);
        
        cla(gh.axis,'reset');
        set(gh.axis,'Box','on');
        set(gh.axis,'Layer','top');
        axes(gh.axis);
        switch ad.control.axis.displayType
            case '2D plot'
                % Disable position slider
                set(gh.slider,'Enable','off');

                z = [ min(min(data)) max(max(data)) ];
                hold on;
                % Plot 2D data
                switch ad.control.axis.MFEdisplay
                    case 'MFon'
                        imagesc(...
                            xvalues,...
                            yvalues,...
                            dataMFon...
                            );
                    case 'DeltaMF'
                        imagesc(...
                            xvalues,...
                            yvalues,...
                            dataMFon-data...
                            );
                    case 'sum(MFoff,MFon)'
                        imagesc(...
                            xvalues,...
                            yvalues,...
                            (dataMFon+data)./2 ...
                            );
                    otherwise
                        imagesc(...
                            xvalues,...
                            yvalues,...
                            data...
                            );
                end
                if ad.control.axis.position
                    % Plot red line with position in time
                    plot(gh.axis,...
                        [xvalues(ad.data{active}.display.position.x) ...
                        xvalues(ad.data{active}.display.position.x)],...
                        [yvalues(1) yvalues(end)],...
                        'r-');
                    % Plot red line with position in field
                    plot(gh.axis,...
                        [xvalues(1) xvalues(end)],...
                        [yvalues(ad.data{active}.display.position.y) ...
                        yvalues(ad.data{active}.display.position.y)],...
                        'r-');
                end
                hold off;
                if isscalar(xvalues)
                    set(gh.axis,'XLim',[xvalues(1)-.5 xvalues(1)+.4]);
                else
                    set(gh.axis,'XLim',[xvalues(1) xvalues(end)]);
                end
                if isscalar(yvalues)
                    set(gh.axis,'YLim',[yvalues(1)-.5 yvalues(1)+.5]);
                else
                    set(gh.axis,'YLim',[yvalues(1) yvalues(end)]);
                end
                set(gh.axis,'YDir','normal');
                set(gh.axis,'CLim',z);
                xlabel(gh.axis,sprintf('{\\it %s} / %s',xmeasure,xunit));
                ylabel(gh.axis,sprintf('{\\it %s} / %s',ymeasure,yunit));
                % Show area
                if ad.data{active}.fit.area.delta && ad.fit.display.area
                    switch ad.fit.dimension
                        case 'x'
                            ylim = get(gh.axis,'YLim');
                            patch(...
                                'XData',[...
                                xvalues(ad.data{active}.fit.area.start) ...
                                xvalues(ad.data{active}.fit.area.start)...
                                xvalues(ad.data{active}.fit.area.stop) ...
                                xvalues(ad.data{active}.fit.area.stop)],...
                                'YData',[ylim(1) ylim(end) ylim(end) ylim(1)],...
                                'ZData',[0 0 0 0],...
                                'EdgeColor',ad.fit.area.patch.edge,...
                                'FaceColor',ad.fit.area.patch.color,...
                                'FaceAlpha',ad.fit.area.patch.alpha,...
                                'Parent',gh.axis);
                        case 'y'
                            xlim = get(gh.axis,'XLim');
                            patch(...
                                'XData',[xlim(1) xlim(end) xlim(end) xlim(1)],...
                                'YData',[...
                                yvalues(ad.data{active}.fit.area.start)...
                                yvalues(ad.data{active}.fit.area.start)...
                                yvalues(ad.data{active}.fit.area.stop)...
                                yvalues(ad.data{active}.fit.area.stop)],...
                                'ZData',[0 0 0 0],...
                                'EdgeColor',ad.fit.area.patch.edge,...
                                'FaceColor',ad.fit.area.patch.color,...
                                'FaceAlpha',ad.fit.area.patch.alpha,...
                                'Parent',gh.axis);
                    end
                end                

            case '1D along x'
                % Enable position slider only if second axis has more than one value
                if (y>1)
                    set(gh.slider,...
                        'Min',1,'Max',y,...
                        'Value',...
                        ad.data{active}.display.position.y,...
                        'SliderStep',[1/(y-1) 10/(y-1)],...
                        'Enable','on');
                else
                    set(gh.slider,...
                        'Enable','off'...
                        );
                end
                % Plot time trace at given position in spectrum
                yvalues = data(ad.data{active}.display.position.y,:);
                if isfield(ad.data{active},'dataMFon')
                    yMF = dataMFon(ad.data{active}.display.position.y,:);
                else
                    yMF = data(ad.data{active}.display.position.y,:);
                end
                hold on;
                switch ad.control.axis.MFEdisplay
                    case 'MFoff'
                        plot(...
                            xvalues,...
                            yvalues,...
                            'Color',ad.data{active}.line.color,...
                            'LineStyle',ad.data{active}.line.style,...
                            'Marker',ad.data{active}.line.marker,...
                            'LineWidth',ad.data{active}.line.width...
                            );
                    case 'MFon'
                        plot(...
                            xvalues,...
                            yMF,...
                            'Color',ad.data{active}.display.MFon.line.color,...
                            'LineStyle',ad.data{active}.display.MFon.line.style,...
                            'Marker',ad.data{active}.display.MFon.line.marker,...
                            'LineWidth',ad.data{active}.display.MFon.line.width...
                            );
                    case 'DeltaMF'
                        plot(...
                            xvalues,...
                            yMF-yvalues,...
                            'Color',ad.data{active}.display.DeltaMF.line.color,...
                            'LineStyle',ad.data{active}.display.DeltaMF.line.style,...
                            'Marker',ad.data{active}.display.DeltaMF.line.marker,...
                            'LineWidth',ad.data{active}.display.DeltaMF.line.width...
                            );
                    case 'sum(MFoff,MFon)'
                        plot(...
                            xvalues,...
                            (yMF+yvalues)./2,...
                            'Color',ad.data{active}.line.color,...
                            'LineStyle',ad.data{active}.line.style,...
                            'Marker',ad.data{active}.line.marker,...
                            'LineWidth',ad.data{active}.line.width...
                            );
                end
                set(gh.axis,'XLim',[xvalues(1) xvalues(end)]);
                z = [ min(min(data)) max(max(data)) ];
                ZLim = [z(1)-((z(2)-z(1))/20) z(2)+((z(2)-z(1))/20)];
                set(gh.axis,'YLim',ZLim);
                if (ad.control.axis.grid.zero)
                    line(...
                        get(gh.axis,'XLim'),...
                        [0 0],...
                        'Color',[0.5 0.5 0.5],'LineStyle','--',...
                        'Parent',gh.axis);
                end
                % Plot red line with position in time
                if ad.control.axis.position
                    plot(gh.axis,...
                        [xvalues(ad.data{active}.display.position.x) ...
                        xvalues(ad.data{active}.display.position.x)],...
                        ZLim,...
                        'r-');
                end
                % Plot fit if available
                if ~isempty(ad.fit.values) && strcmpi(ad.fit.dimension,'x')
                    plot(gh.axis,...
                        ad.fit.values(:,1),...
                        ad.fit.values(:,2),...
                        'Color',ad.fit.MFoff.line.color,...
                        'LineStyle',ad.fit.MFoff.line.style,...
                        'Marker',ad.fit.MFoff.line.marker,...
                        'LineWidth',ad.fit.MFoff.line.width...
                        );
                end
                % Plot residuals if fit available and told to do so
                if ~isempty(ad.fit.values) && ad.fit.display.residuals ...
                         && strcmpi(ad.fit.dimension,'x')
                    plot(gh.axis,...
                        ad.fit.values(:,1),...
                        ad.data{active}.data(...
                        ad.data{active}.display.position.y,...
                        ad.data{active}.fit.area.start:...
                        ad.data{active}.fit.area.stop)-...
                        ad.fit.values(:,2)',...
                        'Color',ad.fit.residuals.line.color,...
                        'LineStyle',ad.fit.residuals.line.style,...
                        'Marker',ad.fit.residuals.line.marker,...
                        'LineWidth',ad.fit.residuals.line.width...
                        );
                end
                hold off;
                xlabel(gh.axis,sprintf('{\\it %s} / %s',xmeasure,xunit));
                ylabel(gh.axis,sprintf('{\\it %s} / %s',zmeasure,zunit));
                % Plot fit area
                if ad.data{active}.fit.area.delta && ...
                        strcmpi(ad.fit.dimension,'x') && ...
                        ad.fit.display.area
                    ylim = get(gh.axis,'YLim');
                    patch(...
                        'XData',[...
                        xvalues(ad.data{active}.fit.area.start) ...
                        xvalues(ad.data{active}.fit.area.start)...
                        xvalues(ad.data{active}.fit.area.stop) ...
                        xvalues(ad.data{active}.fit.area.stop)],...
                        'YData',[ylim(1) ylim(end) ylim(end) ylim(1)],...
                        'ZData',[0 0 0 0],...
                        'EdgeColor',ad.fit.area.patch.edge,...
                        'FaceColor',ad.fit.area.patch.color,...
                        'FaceAlpha',ad.fit.area.patch.alpha,...
                        'Parent',gh.axis);
                end                
            case '1D along y'
                % Enable position slider only if second axis has more than one value
                if (x>1)
                    set(gh.slider,...
                        'Min',1,'Max',x,...
                        'Value',...
                        ad.data{ad.control.spectra.active}.display.position.x,...
                        'SliderStep',[1/(x-1) 10/(x-1)],...
                        'Enable','on');
                else
                    set(gh.slider,...
                        'Enable','off'...
                        );
                end
                % Plot B0 spectrum at given position in time
                xvalues = data(:,ad.data{active}.display.position.x);
                if isfield(ad.data{active},'dataMFon')
                    xMF = dataMFon(:,ad.data{active}.display.position.x);
                else
                    xMF = data(:,ad.data{active}.display.position.x);
                end
                hold on;
                switch ad.control.axis.MFEdisplay
                    case 'MFoff'
                        plot(...
                            yvalues,...
                            xvalues,...
                            'Color',ad.data{active}.line.color,...
                            'LineStyle',ad.data{active}.line.style,...
                            'Marker',ad.data{active}.line.marker,...
                            'LineWidth',ad.data{active}.line.width...
                            );
                    case 'MFon'
                        plot(...
                            yvalues,...
                            xMF,...
                            'Color',ad.data{active}.display.MFon.line.color,...
                            'LineStyle',ad.data{active}.display.MFon.line.style,...
                            'Marker',ad.data{active}.display.MFon.line.marker,...
                            'LineWidth',ad.data{active}.display.MFon.line.width...
                            );
                    case 'DeltaMF'
                        plot(...
                            yvalues,...
                            xMF-xvalues,...
                            'Color',ad.data{active}.display.DeltaMF.line.color,...
                            'LineStyle',ad.data{active}.display.DeltaMF.line.style,...
                            'Marker',ad.data{active}.display.DeltaMF.line.marker,...
                            'LineWidth',ad.data{active}.display.DeltaMF.line.width...
                            );
                    case 'sum(MFoff,MFon)'
                        plot(...
                            yvalues,...
                            (xMF+xvalues)./2,...
                            'Color',ad.data{active}.line.color,...
                            'LineStyle',ad.data{active}.line.style,...
                            'Marker',ad.data{active}.line.marker,...
                            'LineWidth',ad.data{active}.line.width...
                            );
                end
                if isscalar(yvalues)
                    set(gh.axis,'XLim',[yvalues(1)-.5 yvalues(1)+.5]);
                else
                    set(gh.axis,'XLim',[yvalues(1) yvalues(end)]);
                end
                z = [ min(min(data)) max(max(data)) ];
                ZLim = [z(1)-((z(2)-z(1))/20) z(2)+((z(2)-z(1))/20)];
                set(gh.axis,'YLim',ZLim);
                % Plot red line with position in time
                if ad.control.axis.position
                    plot(gh.axis,...
                        [yvalues(ad.data{ad.control.spectra.active}.display.position.y) ...
                        yvalues(ad.data{ad.control.spectra.active}.display.position.y)],...
                        ZLim,...
                        'r-');
                end
                % Plot fit if available
                if ~isempty(ad.fit.values) && strcmpi(ad.fit.dimension,'y')
                    plot(gh.axis,...
                        ad.fit.values(:,1),...
                        ad.fit.values(:,2),...
                        'Color',ad.fit.MFoff.line.color,...
                        'LineStyle',ad.fit.MFoff.line.style,...
                        'Marker',ad.fit.MFoff.line.marker,...
                        'LineWidth',ad.fit.MFoff.line.width...
                        );
                end
                % Plot residuals if fit available and told to do so
                if ~isempty(ad.fit.values) && ad.fit.display.residuals ...
                         && strcmpi(ad.fit.dimension,'y')
                    plot(gh.axis,...
                        ad.fit.values(:,1),...
                        ad.data{active}.data(...
                        ad.data{active}.fit.area.start:...
                        ad.data{active}.fit.area.stop,...
                        ad.data{active}.display.position.x)-...
                        ad.fit.values(:,2),...
                        'Color',ad.fit.residuals.line.color,...
                        'LineStyle',ad.fit.residuals.line.style,...
                        'Marker',ad.fit.residuals.line.marker,...
                        'LineWidth',ad.fit.residuals.line.width...
                        );
                end
                hold off;
                if (ad.control.axis.grid.zero)
                    line(...
                        get(gh.axis,'XLim'),...
                        [0 0],...
                        'Color',[0.5 0.5 0.5],'LineStyle','--',...
                        'Parent',gh.axis);
                end
                xlabel(gh.axis,sprintf('{\\it %s} / %s',ymeasure,yunit));
                ylabel(gh.axis,sprintf('{\\it %s} / %s',zmeasure,zunit));
                % Plot fit area
                if ad.data{active}.fit.area.delta && ...
                        strcmpi(ad.fit.dimension,'y') && ...
                        ad.fit.display.area
                    ylim = get(gh.axis,'YLim');
                    patch(...
                        'XData',[...
                        yvalues(ad.data{active}.fit.area.start)...
                        yvalues(ad.data{active}.fit.area.start)...
                        yvalues(ad.data{active}.fit.area.stop)...
                        yvalues(ad.data{active}.fit.area.stop)],...
                        'YData',[ylim(1) ylim(end) ylim(end) ylim(1)],...
                        'ZData',[0 0 0 0],...
                        'EdgeColor',ad.fit.area.patch.edge,...
                        'FaceColor',ad.fit.area.patch.color,...
                        'FaceAlpha',ad.fit.area.patch.alpha,...
                        'Parent',gh.axis);
                end
        end
        % Set grid for axis
        set(gh.axis,'XGrid',ad.control.axis.grid.x);
        set(gh.axis,'YGrid',ad.control.axis.grid.y);
        if (isequal(ad.control.axis.grid.x,'on'))
            set(gh.axis,'XMinorGrid',ad.control.axis.grid.minor);
        end
        if (isequal(ad.control.axis.grid.y,'on'))
            set(gh.axis,'YMinorGrid',ad.control.axis.grid.minor);
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

function switchMeasurePointer(~,~)
    try
        % Get appdata of main window
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);

        % Get handles from main window
        gh = guidata(mainWindow);
        
        % Reset pointer callback functions
        set(mainWindow,'WindowButtonMotionFcn','');
        set(mainWindow,'WindowButtonDownFcn','');
        
        % Reset pointer
        set(mainWindow,'Pointer','arrow');
        
        % Switch off togglebuttons
        set(gh.measure_pick_togglebutton,'Value',0);
        
        % Update appdata of main window
        setappdata(mainWindow,'control',ad.control);
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function trackPointer(varargin)
    try
        mainWindow = guiGetWindowHandle(mfilename);
        
        % Get handles of mainwindow
        gh = guihandles(mainWindow);
        
        % Get appdata of main window
        ad = getappdata(mainWindow);
        
        % Get position of mainAxis (axis coordinates)
        axisPosition = get(hPlotAxes,'Position');
        % Coordinates are "real" x,y pairs relative to the mainWindow
        axisCoordinates = [ ...
            axisPosition(1)-1 ...
            axisPosition(2)-1 ...
            axisPosition(1)+axisPosition(3) ...
            axisPosition(2)+axisPosition(4) ...
            ];
        
        % Get current position of pointer
        pointerPosition = get(mainWindow,'CurrentPoint');
        
        % Create CData for custom pointer
        pointerShapeCData = ones(16)*nan;
        pointerShapeCData([1 8 15],[1:6 10:15]) = 1;
        pointerShapeCData([1:6 10:15],[1 8 15]) = 1;
        
        % As long as we are inside the mainAxis
        if pointerPosition(1) > axisCoordinates(1) && ...
                pointerPosition(1) < axisCoordinates(3) && ...
                pointerPosition(2) > axisCoordinates(2) && ...
                pointerPosition(2) < axisCoordinates(4)
            
            % Get pointer position coordinates relative to axis
            pointerPositionInAxis = ...
                pointerPosition - [axisCoordinates(1) axisCoordinates(2)];
            
            % Set pointer shape
            %set(mainWindow,'Pointer','crosshair');
            set(mainWindow,'Pointer','custom',...
                'PointerShapeCData',pointerShapeCData,...
                'PointerShapeHotSpot',[9 9]);
            
            % Get xdata and ydata of currently active dataset
            if (strcmp(ad.control.axis.displayType,'2D plot'))
                xdata = get(...
                    findobj('Parent',hPlotAxes,'-and','Type','image'),...
                    'xdata');
                ydata = get(...
                    findobj('Parent',hPlotAxes,'-and','Type','image'),...
                    'ydata');
            else
                xdata = get(...
                    findobj('Parent',hPlotAxes,'-and','Type','line'),...
                    'xdata');
                ydata = get(...
                    findobj('Parent',hPlotAxes,'-and','Type','line'),...
                    'ydata');
            end
    
            % Get id of current spectrum (to shorten lines afterwards)
            active = ad.control.spectra.active;
            
            % If we are in 1D display mode and there are more than one spectrum
            % and/or a zero line displayed
            if ( (strcmp(ad.control.axis.displayType,'1D along x') || ...
                    strcmp(ad.control.axis.displayType,'1D along y')) ) && ...
                    (iscell(xdata) && iscell(ydata))
                if ad.control.axis.grid.zero 
                    xdata = xdata{2};
                    ydata = ydata{2};
                else
                    xdata = xdata{1};
                    ydata = ydata{1};
                end
            end
            
            % Create vectors with indices for xdata and ydata
            % Those are used in case of axis limits <> dataset limits
            xindex = 1 : length(xdata);
            yindex = 1 : length(ydata);
            
            % Handle situation that axis limits and dataset limits don't coincide.
            % Therefore, in case of the dataset being smaller than axis limits, pad
            % it with the first/last value to fill xdata/ydata, respectively.
            % Alternatively, the dataset being larger than axis limits, cut out
            % part from the dataset that's currently displayed.
            % To find out how many points to pad, use interp1 to get ending points
            % of dataset in current axis.
            
            % IMPORTANT: DON'T MESS UP THE CODE BELOW, IF YOU'RE NOT ABSOLUTELY
            % SURE WHAT YOU'RE DOING. I SPEND A WHOLE DAY FIGHTING WITH IT UNTIL IT
            % WORKED SOMEWHAT FINE.
            
            % Get x and y limits of axes
            axisXLim = get(hPlotAxes,'XLim');
            axisYLim = get(hPlotAxes,'YLim');
            % Get x and y limits of currently active dataset
            datasetXLim = [ xdata(1) xdata(end) ];
            datasetYLim = [ ydata(1) ydata(end) ];
            
            % Get dataset limits in axis coordinates
            if (axisXLim(1) > datasetXLim(1))
                % In case dataset is larger than current axis limits
                
                % Need to come up with a good variable name for that, but it looks
                % like we get here the position of the axis limit in the data
                % vector, what would be very useful
                newDatasetXmin=interp1(...
                    linspace(datasetXLim(1),datasetXLim(2),length(xdata)),...
                    linspace(1,length(xdata),length(xdata)),...
                    axisXLim(1),'nearest');
                newXdata = xdata(newDatasetXmin:end);
                newXindex = xindex(newDatasetXmin:end);
            else
                newDatasetXmin=interp1(...
                    linspace(axisXLim(1),axisXLim(2),length(xdata)),...
                    linspace(1,length(xdata),length(xdata)),...
                    xdata(1),'nearest');
                newXdata = [ones(1,newDatasetXmin)*xdata(1) xdata];
                newXindex = [ones(1,newDatasetXmin)*xindex(1) xindex];
            end
            if (axisXLim(2) < datasetXLim(2))
                % In case dataset is larger than current axis limits
                
                % Need to come up with a good variable name for that, but it looks
                % like we get here the position of the axis limit in the data
                % vector, what would be very useful
                newDatasetXmax=interp1(...
                    linspace(datasetXLim(1),datasetXLim(end),length(xdata)),...
                    linspace(1,length(xdata),length(xdata)),...
                    axisXLim(2),'nearest');
                newXdata = newXdata(1:end-(length(xdata)-newDatasetXmax));
                newXindex = newXindex(1:end-(length(xindex)-newDatasetXmax));
            else
                newDatasetXmax=interp1(...
                    linspace(axisXLim(1),axisXLim(2),length(xdata)),...
                    linspace(1,length(xdata),length(xdata)),...
                    xdata(end),'nearest');
                newXdata = [newXdata ones(1,length(xdata)-newDatasetXmax)*xdata(end)];
                newXindex = [newXindex ones(1,length(xindex)-newDatasetXmax)*xindex(end)];
            end
            
            if (strcmp(ad.control.axis.displayType,'2D plot'))
                if (axisYLim(1) > datasetYLim(1))
                    % In case dataset is larger than current axis limits
                    
                    % Need to come up with a good variable name for that, but it looks
                    % like we get here the position of the axis limit in the data
                    % vector, what would be very useful
                    newDatasetYmin=interp1(...
                        linspace(datasetYLim(1),datasetYLim(2),length(ydata)),...
                        linspace(1,length(ydata),length(ydata)),...
                        axisYLim(1),'nearest');
                    newYdata = ydata(newDatasetYmin:end);
                    newYindex = yindex(newDatasetYmin:end);
                else
                    newDatasetYmin=interp1(...
                        linspace(axisYLim(1),axisYLim(2),length(ydata)),...
                        linspace(1,length(ydata),length(ydata)),...
                        ydata(1),'nearest');
                    newYdata = [ones(1,newDatasetYmin)*ydata(1) ydata];
                    newYindex = [ones(1,newDatasetYmin)*yindex(1) yindex];
                end
                if (axisYLim(2) < datasetYLim(2))
                    % In case dataset is larger than current axis limits
                    
                    % Need to come up with a good variable name for that, but it looks
                    % like we get here the position of the axis limit in the data
                    % vector, what would be very useful
                    newDatasetYmax=interp1(...
                        linspace(datasetYLim(1),datasetYLim(end),length(ydata)),...
                        linspace(1,length(ydata),length(ydata)),...
                        axisYLim(2),'nearest');
                    newYdata = newYdata(1:end-(length(ydata)-newDatasetYmax));
                    newYindex = newYindex(1:end-(length(yindex)-newDatasetYmax));
                else
                    newDatasetYmax=interp1(...
                        linspace(axisYLim(1),axisYLim(2),length(ydata)),...
                        linspace(1,length(ydata),length(ydata)),...
                        ydata(end),'nearest');
                    newYdata = [newYdata ones(1,length(ydata)-newDatasetYmax)*ydata(end)];
                    newYindex = [newYindex ones(1,length(yindex)-newDatasetYmax)*yindex(end)];
                end
            end
            
            switch ad.control.axis.displayType
                case '2D plot'
                    % Get index of current point in dataset
                    indx=interp1(...
                        linspace(1,axisPosition(3),length(newXdata)),...
                        newXindex,...
                        pointerPositionInAxis(1),'nearest');
                    indy=interp1(...
                        linspace(1,axisPosition(4),length(newYdata)),...
                        newYindex,...
                        pointerPositionInAxis(2),'nearest');
                case '1D along x'
                    % Get index of current point in dataset
                    indx=interp1(...
                        linspace(1,axisPosition(3),length(newXdata)),...
                        newXindex,...
                        pointerPositionInAxis(1),'nearest');
                    indy=indx;
                case '1D along y'
                    % Get index of current point in dataset
                    indx=interp1(...
                        linspace(1,axisPosition(3),length(newXdata)),...
                        newXindex,...
                        pointerPositionInAxis(1),'nearest');
                    indy=indx;
                otherwise
                    % That shall never happen!
                    disp('trackPointer(): Unrecognised displayType');
                    disp(ad.control.axis.displayType);
                    set(mainWindow,'Pointer','arrow');
                    return;
            end
            
            % Get value (in units) of current point in dataset
            valx = xdata(indx);
            valy = ydata(indy);
            
            % Set display
            % Update display of first point
            set(gh.measure_x_index_edit,'String',num2str(indx));
            set(gh.measure_x_unit_edit,'String',num2str(valx));
            set(gh.measure_y_index_edit,'String',num2str(indy));
            set(gh.measure_y_unit_edit,'String',num2str(valy));
        else
            set(mainWindow,'Pointer','arrow');
        end
        
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function parameters = collectFitParameters()
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata from fit GUI
        ad = getappdata(mainWindow);

        % Get handles of mainwindow
        gh = guihandles(mainWindow);
        
        active = ad.control.spectra.active;
        
        if isempty(active) || ~active
            parameters = [];
        end
        
        fitDimensions = cellstr(get(gh.dimension_popupmenu,'String'));
        parameters.dimension = fitDimensions{get(gh.dimension_popupmenu,'Value')}(1);
        parameters.mfetrace = ad.control.axis.MFEdisplay;
        parameters.area = ad.data{active}.fit.area;
        switch parameters.dimension
            case 'x'
                parameters.position = ad.data{active}.display.position.y;
            case 'y'
                parameters.position = ad.data{active}.display.position.x;
        end
        parameters.fitRoutineName = 'fminsearch';
        fitFunNames = cellstr(get(gh.fitfunction_popupmenu,'String'));
        parameters.fitFunName = ...
            fitFunNames{get(gh.fitfunction_popupmenu,'Value')};
        %parameters.fitFunName = 'Exp. decay';
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function [fit,fval,message] = doFit(data,fitFunType,ignorefirstn)
    function stop = outfun(x, optimValues, state)
        stop = false;
        message{end+1} = sprintf('  %6.0f     %6.0f    %10f  %s',...
            optimValues.iteration,optimValues.funccount,...
            optimValues.fval,optimValues.procedure);
    end
    
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata from fit GUI
        ad = getappdata(mainWindow);
        
        x1 = data(1,ignorefirstn+1:size(data,2));
        x2 = data(1,1:size(data,2));
        
        message = cell(0);
        message{end+1} = ...
            sprintf('Iteration  FuncCount    min f(x)   Procedure');
        
        % Set options for fminsearch
        fitopt = optimset(...
            'Display','Off',...
            'OutputFcn', @outfun ... 
            );

        switch fitFunType
            case 'exponential'
                % A1*exp(k1*x)
                fun1 = @(z)z(1)*exp(z(2)*x1+z(3));
                fun2 = @(z)z(1)*exp(z(2)*x2+z(3));
                fitfun = @(z)sum((fun1(z)-data(2,ignorefirstn+1:end)).^2);
                % Fit function
                [Y,fval,exitflag,output] = fminsearch(fitfun,[1 -1 0],fitopt);
                fit = fun2(Y);
            case 'biexponential'
                % A1*exp(k1*x) + A2*exp(k2*x)
                fun1 = @(z)z(1)*exp(z(2)*x1+z(3))+z(4)*exp(z(5)*x1+z(6));
                fun2 = @(z)z(1)*exp(z(2)*x2+z(3))+z(4)*exp(z(5)*x2+z(6));
                fitfun = @(z)sum((fun1(z)-data(2,ignorefirstn+1:end)).^2);
                % Fit function
                [Y,fval,exitflag,output] = fminsearch(fitfun,[1 -1 0 1 -1 0],fitopt);
                fit = fun2(Y);
        end
        
        % Create message
        message{end+1} = ''; % Empty line
        message{end+1} = 'SUMMARY';
        message{end+1} = sprintf('Algorithm: %s',output.algorithm);
        message{end+1} = sprintf('Number of iterations: %i',output.iterations);
        message{end+1} = sprintf('Number of function evaluations: %i',output.funcCount);
        if (exitflag ~= 1)
            message{end+1} = output.message;
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            TAgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

end